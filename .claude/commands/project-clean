#!/usr/bin/env node

/**
 * ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚³ãƒãƒ³ãƒ‰
 * ä½¿ç”¨æ³•: /project-clean [--deep] [--confirm]
 * æ©Ÿèƒ½: ä¸è¦ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ã€ä¾å­˜é–¢ä¿‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

class ProjectCleaner {
  constructor() {
    this.deepClean = process.argv.includes('--deep');
    this.autoConfirm = process.argv.includes('--confirm');
    this.language = this.detectLanguage();
    this.packageManager = this.detectPackageManager();
    this.filesToDelete = [];
    this.dirsToDelete = [];
    this.commandsToRun = [];
  }

  detectLanguage() {
    if (fs.existsSync('package.json')) return 'javascript';
    if (fs.existsSync('pyproject.toml') || fs.existsSync('requirements.txt')) return 'python';
    if (fs.existsSync('Cargo.toml')) return 'rust';
    if (fs.existsSync('go.mod')) return 'go';
    return 'javascript';
  }

  detectPackageManager() {
    if (fs.existsSync('pnpm-lock.yaml')) return 'pnpm';
    if (fs.existsSync('yarn.lock')) return 'yarn';
    if (fs.existsSync('bun.lockb')) return 'bun';
    return 'npm';
  }

  async clean() {
    console.log(`ğŸ§¹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹ (${this.deepClean ? 'ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°' : 'æ¨™æº–ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°'})`);

    this.identifyCleanupTargets();
    await this.showCleanupPlan();

    if (!this.autoConfirm) {
      const readline = require('readline');
      const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
      });

      const answer = await new Promise(resolve => {
        rl.question('\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N): ', resolve);
      });

      rl.close();

      if (answer.toLowerCase() !== 'y' && answer.toLowerCase() !== 'yes') {
        console.log('âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        return;
      }
    }

    await this.executeCleanup();
    this.showResults();
  }

  identifyCleanupTargets() {
    // å…±é€šã®å‰Šé™¤å¯¾è±¡
    const commonDirs = [
      'dist',
      'build',
      'out',
      '.vite',
      '.next',
      '.nuxt',
      'coverage',
      '.coverage',
      '.nyc_output',
      '.cache',
      'tmp',
      'temp'
    ];

    const commonFiles = [
      '.DS_Store',
      'Thumbs.db',
      '*.log',
      '*.tmp',
      '*.swp',
      '*.swo',
      '*~'
    ];

    // è¨€èªå›ºæœ‰ã®å‰Šé™¤å¯¾è±¡
    switch (this.language) {
      case 'javascript':
        this.dirsToDelete.push(...commonDirs, 'node_modules/.vite', 'node_modules/.cache');
        this.filesToDelete.push(...commonFiles, 'npm-debug.log*', 'yarn-error.log*');

        if (this.deepClean) {
          this.dirsToDelete.push('node_modules');
          this.commandsToRun.push(() => {
            console.log('ğŸ“¦ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢...');
            try {
              if (this.packageManager === 'npm') {
                execSync('npm cache clean --force', { stdio: 'inherit' });
              } else if (this.packageManager === 'yarn') {
                execSync('yarn cache clean', { stdio: 'inherit' });
              } else if (this.packageManager === 'pnpm') {
                execSync('pnpm store prune', { stdio: 'inherit' });
              }
            } catch (error) {
              console.log('âš ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ã§ã‚¨ãƒ©ãƒ¼:', error.message);
            }
          });
        }
        break;

      case 'python':
        this.dirsToDelete.push(...commonDirs, '__pycache__', '*.egg-info', '.pytest_cache', '.mypy_cache');
        this.filesToDelete.push(...commonFiles, '*.pyc', '*.pyo', '*.pyd');

        if (this.deepClean) {
          this.dirsToDelete.push('.venv', 'venv', '.env');
        }
        break;

      case 'rust':
        this.dirsToDelete.push(...commonDirs, 'target');
        this.filesToDelete.push(...commonFiles, 'Cargo.lock');

        if (this.deepClean) {
          this.commandsToRun.push(() => {
            console.log('ğŸ¦€ Cargo ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢...');
            try {
              execSync('cargo clean', { stdio: 'inherit' });
            } catch (error) {
              console.log('âš ï¸ Cargo clean ã§ã‚¨ãƒ©ãƒ¼:', error.message);
            }
          });
        }
        break;

      case 'go':
        this.dirsToDelete.push(...commonDirs);
        this.filesToDelete.push(...commonFiles);

        if (this.deepClean) {
          this.commandsToRun.push(() => {
            console.log('ğŸ¹ Go ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢...');
            try {
              execSync('go clean -modcache', { stdio: 'inherit' });
            } catch (error) {
              console.log('âš ï¸ Go clean ã§ã‚¨ãƒ©ãƒ¼:', error.message);
            }
          });
        }
        break;
    }

    // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒ»IDEå›ºæœ‰ãƒ•ã‚¡ã‚¤ãƒ«
    if (this.deepClean) {
      this.dirsToDelete.push('.vscode', '.idea');
      this.filesToDelete.push('*.sublime-*');
    }

    // å®Ÿéš›ã«å­˜åœ¨ã™ã‚‹ã‚‚ã®ã ã‘ã‚’å¯¾è±¡ã«ã™ã‚‹
    this.dirsToDelete = this.dirsToDelete.filter(dir => fs.existsSync(dir));
    this.filesToDelete = this.filesToDelete.filter(pattern => {
      // glob ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å ´åˆã¯ç°¡æ˜“çš„ã«ãƒã‚§ãƒƒã‚¯
      if (pattern.includes('*')) {
        return true; // glob ã¯å‰Šé™¤æ™‚ã«ãƒã‚§ãƒƒã‚¯
      }
      return fs.existsSync(pattern);
    });
  }

  async showCleanupPlan() {
    console.log('\nğŸ“‹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—è¨ˆç”»:');

    if (this.dirsToDelete.length > 0) {
      console.log('\nğŸ“ å‰Šé™¤å¯¾è±¡ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:');
      this.dirsToDelete.forEach(dir => {
        const size = this.getDirectorySize(dir);
        console.log(`  - ${dir} ${size ? `(${this.formatBytes(size)})` : ''}`);
      });
    }

    if (this.filesToDelete.length > 0) {
      console.log('\nğŸ“„ å‰Šé™¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«:');
      this.filesToDelete.forEach(file => {
        console.log(`  - ${file}`);
      });
    }

    if (this.commandsToRun.length > 0) {
      console.log('\nğŸ”§ å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰:');
      console.log(`  - ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢`);
    }

    const totalSize = this.dirsToDelete.reduce((total, dir) => {
      return total + (this.getDirectorySize(dir) || 0);
    }, 0);

    if (totalSize > 0) {
      console.log(`\nğŸ’¾ æ¨å®šå‰Šé™¤ã‚µã‚¤ã‚º: ${this.formatBytes(totalSize)}`);
    }
  }

  async executeCleanup() {
    console.log('\nğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œä¸­...');

    let deletedCount = 0;
    let deletedSize = 0;

    // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤
    for (const dir of this.dirsToDelete) {
      if (fs.existsSync(dir)) {
        const size = this.getDirectorySize(dir);
        try {
          fs.rmSync(dir, { recursive: true, force: true });
          console.log(`âœ… å‰Šé™¤: ${dir}`);
          deletedCount++;
          deletedSize += size || 0;
        } catch (error) {
          console.log(`âŒ å‰Šé™¤å¤±æ•—: ${dir} (${error.message})`);
        }
      }
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
    for (const pattern of this.filesToDelete) {
      try {
        if (pattern.includes('*')) {
          // ç°¡æ˜“çš„ãªglobå‡¦ç†
          const files = this.findFilesByPattern(pattern);
          for (const file of files) {
            fs.unlinkSync(file);
            console.log(`âœ… å‰Šé™¤: ${file}`);
            deletedCount++;
          }
        } else if (fs.existsSync(pattern)) {
          fs.unlinkSync(pattern);
          console.log(`âœ… å‰Šé™¤: ${pattern}`);
          deletedCount++;
        }
      } catch (error) {
        console.log(`âŒ å‰Šé™¤å¤±æ•—: ${pattern} (${error.message})`);
      }
    }

    // ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ
    for (const command of this.commandsToRun) {
      try {
        await command();
      } catch (error) {
        console.log(`âš ï¸ ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
    }

    console.log(`\nğŸ“Š å‰Šé™¤å®Œäº†: ${deletedCount} é …ç›®, ${this.formatBytes(deletedSize)}`);
  }

  findFilesByPattern(pattern) {
    const files = [];
    const regex = new RegExp(pattern.replace(/\*/g, '.*'));

    const searchDir = (dir) => {
      try {
        const items = fs.readdirSync(dir);
        for (const item of items) {
          const fullPath = path.join(dir, item);
          const stat = fs.statSync(fullPath);

          if (stat.isFile() && regex.test(item)) {
            files.push(fullPath);
          } else if (stat.isDirectory() && !item.startsWith('.')) {
            searchDir(fullPath);
          }
        }
      } catch (error) {
        // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªèª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
      }
    };

    searchDir('.');
    return files.slice(0, 100); // æœ€å¤§100ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã§
  }

  getDirectorySize(dirPath) {
    try {
      let totalSize = 0;
      const items = fs.readdirSync(dirPath);

      for (const item of items) {
        const fullPath = path.join(dirPath, item);
        const stat = fs.statSync(fullPath);

        if (stat.isDirectory()) {
          totalSize += this.getDirectorySize(fullPath);
        } else {
          totalSize += stat.size;
        }
      }

      return totalSize;
    } catch (error) {
      return 0;
    }
  }

  formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  showResults() {
    console.log('\nâœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†ï¼');
    console.log('\nğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:');

    switch (this.language) {
      case 'javascript':
        console.log(`  ${this.packageManager === 'npm' ? 'npm install' : `${this.packageManager} install`} - ä¾å­˜é–¢ä¿‚ã‚’å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«`);
        break;
      case 'python':
        console.log('  pip install -e ".[dev]" - ä¾å­˜é–¢ä¿‚ã‚’å†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«');
        break;
      case 'rust':
        console.log('  cargo build - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å†ãƒ“ãƒ«ãƒ‰');
        break;
      case 'go':
        console.log('  go mod download - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å†ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰');
        break;
    }

    console.log('\nğŸ”— é–¢é€£ã‚³ãƒãƒ³ãƒ‰:');
    console.log('  /project-analyze - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†åˆ†æ');
    console.log('  /deps-update - ä¾å­˜é–¢ä¿‚æ›´æ–°');
    console.log('  /quality-setup - å“è³ªãƒ„ãƒ¼ãƒ«è¨­å®š');
  }
}

// ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
if (require.main === module) {
  new ProjectCleaner().clean();
}

module.exports = { ProjectCleaner };