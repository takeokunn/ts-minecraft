# プロジェクト規約 (Project Conventions)

このドキュメントでは、プロジェクト全体で一貫性、可読性、保守性を維持するために遵守すべきコーディングスタイル、規約、設計パターンについて詳述します。

---

## 1. 基本設計思想

本プロジェクトは、堅牢かつスケール可能なアプリケーションを構築するため、以下の設計思想を根幹に据えています。

- **関数型プログラミング**: 副作用を厳密に管理し、コードの予測可能性を高めるため、[**Effect-TS**](https://effect.website/) を全面的に採用します。すべての処理は `Effect` データ型でラップされ、合成可能なプログラムとして構築されます。
- **Immutability (不変性)**: すべてのデータ構造は原則として不変（Immutable）に扱います。これにより、状態の意図しない変更を防ぎ、アプリケーションの健全性を保ちます。
- **クラス不使用**: `class` 構文と `this` キーワードは一切使用しません。状態とロジックを分離し、純粋な関数とデータ型でアプリケーションを構成します。
- **宣言的なコーディング**: `if/else` や `switch` による命令的な分岐よりも、[**ts-pattern**](https://github.com/gvergnaud/ts-pattern) を用いた宣言的なパターンマッチングを推奨します。

---

## 2. コードフォーマット & 静的解析

コードの品質とスタイルは、**Oxlint** (リンター) と **BiomeJS** (フォーマッタ) によって自動的に維持されます。開発中は、常に以下のコマンドでコードを検証・整形してください。

```bash
# Oxlintによる静的解析・自動修正
pnpm run lint

# BiomeJSによる自動フォーマット
pnpm run format

# TypeScriptによる型チェック
pnpm exec tsc
```

これらのチェックはCIでも強制されます。

### リンター: Oxlint

- **役割**: コードの潜在的なバグ、パフォーマンスの問題、一貫性のないパターンを検出します。

### フォーマッタ: BiomeJS

- **役割**: コードの見た目を統一します。
- **設定ファイル**: `biome.json`

---

## 3. TypeScriptの厳格なルール

コードの堅牢性を最大限に高めるため、`tsconfig.json` でTypeScriptの最も厳格な設定を有効にしています。これに加え、以下のルールを徹底します。

- **`any` / `unknown` の禁止**:
  - `any` の使用は固く禁じられています。
  - 型が不明な場合は `unknown` を使用しますが、`as unknown` のような安易な型キャストは避け、型ガードや `@effect/schema/Schema` を用いて安全に型を絞り込みます。
- **`@effect/schema` による型定義**: すべてのドメインデータ、APIレスポンス、外部データは `Schema` を用いて定義します。これにより、パースと型ガードが自動的に提供され、ランタイムエラーを防ぎます。

---

## 4. 命名規則とimportパス

### 命名規則

| 対象                             | 規則                  | 例                                           |
| :------------------------------- | :-------------------- | :------------------------------------------- |
| **ファイル**                     | `kebab-case`          | `block-interaction.ts`, `player-movement.ts` |
| **変数・関数**                   | `camelCase`           | `playerMovementSystem`, `calculateVelocity`  |
| **型・インターフェース・Schema** | `PascalCase`          | `Position`, `EntityId`, `RenderService`      |
| **定数**                         | `UPPER_SNAKE_CASE`    | `MAX_CHUNK_HEIGHT`, `PLAYER_SPEED`           |
| **Effect Layer**                 | `PascalCase` + `Live` | `RendererLive`, `WorldLive`                  |

### importパスの統一

モジュールのimportパスは、可読性と一貫性のため、以下のいずれかに統一します。

- **`@/`**: `src` ディレクトリの絶対パスエイリアス。ネストが深いファイルからのimportに推奨されます。
  - 例: `import { movableQuery } from '@/domain/queries';`
- **`./` または `../`**: 同じディレクトリ、または親ディレクトリからの相対パス。
  - 例: `import { createPlayer } from './archetypes';`

---

## 5. アーキテクチャ原則

プロジェクトは、**Effect-TS** を全面的に採用した **Entity Component System (ECS)** アーキテクチャに基づいています。

### パフォーマンス

- **高速な動作**: システム、特にゲームループ内で実行される処理は、常にパフォーマンスを意識して実装します。不要なメモリアロケーションを避け、GC（ガベージコレクション）の負荷を最小限に抑える設計を心がけます。
- **`querySoA` の原則**: `World` サービスからエンティティを取得する際は、パフォーマンス上の理由から `world.querySoA()` に一本化します。これは中間オブジェクトの生成を完全に排除し、GC負荷を最小化します。

### テスト容易性

- **純粋な関数**: システムやロジックは、可能な限り純粋な関数として実装します。これにより、副作用から隔離され、テストが容易になります。
- **PBT（Property-Based Testing）**: 純粋な関数で構成されたロジックは、Property-Based Testingとの相性が非常に良いです。テストの記述は必須ではありませんが、将来的なテスト導入を容易にするため、この設計を推奨します。

### その他

- **コンポーネントは純粋なデータ**: `domain/components.ts` で定義されるコンポーネントは、`@effect/schema` を用いた純粋なデータコンテナです。
- **システムは単一責任**: `systems/` 内の各システムは、明確に定義された単一の責務を持ちます。
- **クエリは共通化**: `domain/queries.ts` でクエリを一元管理します。
- **エンティティ生成はArchetype**: `domain/archetypes.ts` で定義されたファクトリ関数を通じてエンティティを生成します。
- **依存性の注入 (DI)**: 依存関係はすべてEffectの `Context` と `Layer` によって管理されます。

---

## 6. コミットメッセージ

本プロジェクトは、[**Conventional Commits**](https://www.conventionalcommits.org/) 仕様に厳密に従います。

- **`feat`**: 新機能
- **`fix`**: バグ修正
- **`docs`**: ドキュメント
- **`style`**: コードスタイル
- **`refactor`**: リファクタリング
- **`test`**: テスト
- **`chore`**: ビルドプロセスや補助ツール

---

## 7. 継続的インテグレーション (CI)

品質を維持するため、すべてのプルリクエストに対してCIパイプラインが実行されます。

- **設定ファイル**: `.github/workflows/ci.yml`
- **チェック項目**:
  1.  依存関係のインストール (`pnpm i`)
  2.  静的解析 (`pnpm lint`)
  3.  型チェック (`pnpm exec tsc`)
  4.  単体テスト (`pnpm test`)

すべてのチェックが成功しなければ、マージは許可されません。
