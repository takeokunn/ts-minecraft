# テスト戦略 (Testing Strategy)

本プロジェクトでは、コードベースの品質と信頼性を保証するため、テストを体系的に記述します。目標は、コードが堅牢で、保守可能で、不安定なテストがないことを保証することです。

## コア原則

1.  **純粋関数的なシステム**: すべてのゲームロジック（System）は、副作用のない純粋な関数として実装されます。`System`は現在の`World`の状態を受け取り、新しい変更された`World`の状態を返す関数です。これにより、テストは決定論的でシンプルになり、入力状態と期待される出力状態を比較することに集中できます。

2.  **PBT（プロパティベーステスト）ファースト**: `fast-check`を用いたプロパティベーステストを、ロジックを検証する主要な方法として採用します。個々のテストケースを手動で記述する代わりに、「どのような入力であっても、このプロパティ（性質）は常に真でなければならない」という不変条件を定義します。`fast-check`は、これらのプロパティを反証しようと、何百ものランダムな入力を自動生成します。
    - **利点**: 開発者が想定しないエッジケースを含む広範な入力に対して、ロジックの不変条件が維持されることを保証します。数学的または物理ベースのロジックや、複雑な状態遷移のテストに特に強力です。

3.  **スキーマ駆動のテスト**: `@effect/schema`で定義されたデータ構造から、`@effect/schema/Arbitrary`を用いてテストデータを自動生成します。これにより、テストとドメインモデルが常に同期し、信頼性が向上します。

4.  **Effectの活用**: Effect-TSで書かれたプログラムは、`Layer`による依存性の注入と`Effect.runPromise`を活用して、テスト環境下で安全かつ簡単に実行・検証します。

5.  **境界での統合テスト**: アプリケーション全体を構成する`main.ts`のようなエントリーポイントは、統合テストで検証します。このテストは主要なモジュール（レンダリング、入力、ワールドなど）をモックし、アプリケーション起動時にそれらがすべて正しく接続されていることを確認します。

---

## テスト対象と観点

### 1. `domain/` (ドメイン層)

ドメイン層はビジネスロジックの核であり、最も厳密にテストされます。

- **Components (`components.ts`)**:
  - **PBT**: スキーマのエンコード/デコードが可逆的であること（`decode(encode(data)) === data`）を保証します。
- **Archetypes (`archetypes.ts`)**:
  - **ユニットテスト**: `createArchetype`ファクトリが、指定された種類のエンティティに対して、期待されるコンポーネントの完全なセットを生成することを検証します。
- **純粋な計算ロジック (e.g., `camera-logic.ts`)**:
  - **PBT/ユニットテスト**: 角度計算やベクトル演算などの純粋な関数が、あらゆる入力に対して数学的に正しい結果を返すことを検証します。

### 2. `systems/` (システム層)

各システムは、`World`の状態遷移ロジックの単位としてテストされます。

- **テスト方法**:
  1.  テストシナリオに応じたエンティティとコンポーネントを持つ初期状態の`World`を準備します。
  2.  対象のシステムを実行する`Effect`を構築します。
  3.  `Effect.runPromise`でEffectを実行し、変更後の新しい`World`を取得します。
  4.  新しい`World`の状態（コンポーネントの値など）が期待通りに変更されていることをアサートします。
- **テスト観点**:
  - **PBT**: システムを適用前後で維持されるべき不変条件（例: `collisionSystem`適用後にエンティティがめり込んでいない）をテストします。
  - **ユニットテスト**: 特定の入力（例: `InputState`が`jump`）に対して、期待される状態遷移（例: `Velocity`の`dy`が正の値になる）が発生することを検証します。
  - **ts-patternの活用**: 複数のコンポーネントの状態の組み合わせによって挙動が変化するような複雑なシステムのテストにおいて、`ts-pattern`を活用します。これにより、テストケースの網羅性を高めつつ、可読性の高いテストコードを記述します。

### 3. `runtime/` (ランタイム層)

ランタイム層は、ゲームの実行基盤を支えるサービスをテストします。

- **`world.ts`**:
  - **ユニットテスト**: `World`サービスのCRUD操作（エンティティ作成/削除、コンポーネント追加/削除/取得）やクエリ機能が、仕様通りに動作することを検証します。
  - **PBT**: 大量のエンティティやコンポーネントを追加・削除するような高負荷な状況でも、`World`の内部状態の整合性が保たれることを保証します。

### 4. `infrastructure/` (インフラ層)

インフラ層は外部API（ブラウザ、Three.jsなど）との境界です。テストではこれらの依存をモックに差し替えます。

- **テスト方法**: Effectの`Layer`と`Context`を活用し、テスト対象のサービスが依存するインターフェース（例: `InputManager`）を、テスト用のモック実装に差し替えます。
- **テスト観点**: 外部からの入力（例: モック化したキーボードイベント）に対して、サービスが正しく応答し、期待される`Effect`や状態変化を生成することを検証します。

---

この戦略に従い、各モジュールに対して体系的にテストを追加し、カバレッジ90%を目指します。