# 使用技術 (Technologies)

本プロジェクトで採用している主要なライブラリ、フレームワーク、ツールについて解説します。

---

## 1. コアライブラリ

### [Effect](https://effect.website/)

-   **役割**: アプリケーション全体のアーキテクチャの根幹。
-   **概要**: TypeScriptのための関数型プログラミングエコシステム。単なるライブラリではなく、堅牢でスケーラブルなアプリケーションを構築するための包括的なフレームワークです。
-   **採用理由**:
    -   **副作用の厳密な管理**: `src/infrastructure`層で行われるDOM操作、Workerとの通信、Three.jsの呼び出しといった副作用を`Effect`データ型にカプセル化しています。これにより、`src/systems`層のゲームロジックを純粋な関数として記述でき、テスト容易性と予測可能性を劇的に向上させています。
    -   **構造化された並行処理**: `Fiber`をベースにした高度な並行・非同期処理を活用しています。例えば、`src/systems/chunk-loading.ts`では、複数のチャンク生成Workerへのタスク発行を`Effect.fork`を用いてノンブロッキングに実行しています。
    -   **依存性注入 (DI)**: `Layer`と`Context`を用いた強力なDIシステムは`src/main.ts`で集中的に使用され、`World`や`Renderer`といったサービスの具体的な実装（Live版）をアプリケーション全体に提供しています。
    -   **エコシステム**: `Ref`（`src/runtime/world.ts`での状態管理）、`Queue`（`src/runtime/render-queue.ts`でのコマンド伝達）など、豊富なツールがプロジェクトの随所で活用されています。

### [@effect/schema](https://effect.website/docs/guides/schema/schema)

-   **役割**: データモデリングとバリデーション。
-   **概要**: Effectエコシステムの一部であり、TypeScriptの型定義からランタイムのバリデーション、エンコード/デコードスキーマまでを一度に生成できる強力なツールです。
-   **採用理由**:
    -   **ECSのコンポーネント定義**: プロジェクトの核となるECSのコンポーネントは`src/domain/components.ts`ですべて`Schema.Class`を用いて定義されています。これにより、コンポーネントのデータ構造が静的にも動的にも保証されます。
    -   **不変性の強制**: `Schema`から生成される型はデフォルトで`Readonly`であり、意図しないデータ変更を防ぎ、関数型プログラミングの原則をサポートします。
    -   **セーブ/ロード機能**: `src/runtime/save-load.ts`で定義された`SaveState`スキーマは、ゲームの状態をJSONとして安全にシリアライズ・デシリアライズする上で中心的な役割を果たします。

### [Three.js](https://threejs.org/)

-   **役割**: 3Dレンダリングエンジン。
-   **概要**: WebGLを抽象化し、3Dシーン、カメラ、メッシュ、マテリアルなどを簡単に操作できるようにする、Webで最も広く使われている3Dライブラリです。
-   **採用理由**:
    -   **実績とコミュニティ**: 豊富なドキュメント、サンプル、そして巨大なコミュニティが存在し、問題解決が容易です。
    -   **パフォーマンス**: `src/infrastructure/renderer-three.ts`では、多数のブロックを効率的に描画するために`InstancedMesh`を活用しています。
    -   **柔軟性**: レンダリングに関する具体的な実装は`infrastructure`層に完全にカプセル化されており、Three.jsの機能を直接的かつ強力に利用しつつも、他のシステムからは抽象化されています。

---

## 2. 開発ツールとユーティリティ

### [Vite](https://vitejs.dev/)
-   **役割**: フロントエンドのビルドツール兼開発サーバー。
-   **採用理由**: HMR（ホットモジュールリプレースメント）による非常に高速な開発サイクルと、シンプルな設定でTypeScriptやWeb Workerを含むモダンな開発環境を構築できるため。

### [TypeScript](https://www.typescriptlang.org/)
-   **役割**: 静的型付け言語。
-   **採用理由**: 大規模なコードベースの保守性を高め、多くのエラーをコンパイル時に防ぐことができるため。Effect-TSの能力を最大限に活かす上で必須です。

### [BiomeJS](https://biomejs.dev/)
-   **役割**: コードフォーマッタ & リンター。
-   **採用理由**: `package.json`の`format`および`lint`スクリプトで定義されており、コードスタイルをプロジェクト全体で統一し、潜在的な問題を検出するために使用されます。Rust製で非常に高速です。

### [ts-pattern](https://github.com/gvergnaud/ts-pattern)
-   **役割**: パターンマッチングライブラリ。
-   **概要**: TypeScriptで表現力豊かなパターンマッチングを実現します。
-   **採用理由**: `src/infrastructure/input-browser.ts`において、キーボードの入力イベントを処理するために使用されています。`if/else`や`switch`文のネストを避けることができ、どのキーがどのアクションに対応するのかを宣言的かつ可読性高く記述できます。

### [simplex-noise](httpss://github.com/jwagner/simplex-noise.js) & [alea](https://www.npmjs.com/package/alea)
-   **役割**: プロシージャルな地形生成。
-   **概要**: `simplex-noise`はシンプレックスノイズを生成するためのライブラリ、`alea`はシード可能な乱数生成器(PRNG)です。
-   **採用理由**: `src/workers/computation.worker.ts`の地形生成ロジックで使用されています。シンプレックスノイズを用いることで自然で滑らかな地形を生成し、`alea`と組み合わせることで、同じシード値からは常に同じワールドが生成される、再現性のあるワールド生成を実現しています。

### [stats.js](https://github.com/mrdoob/stats.js/)
-   **役割**: パフォーマンスモニタリング。
-   **概要**: FPSやメモリ使用量をリアルタイムで画面上に表示する軽量なパフォーマンスモニターです。
-   **採用理由**: `src/runtime/loop.ts`で統合されており、開発中にパフォーマンスのボトルネックを特定し、最適化を行うための重要な指標を提供します。

### [file-saver](https://github.com/eligrey/FileSaver.js/)
-   **役割**: ファイル保存機能。
-   **概要**: クライアントサイドでファイルを生成し、ユーザーのデバイスに保存するためのライブラリです。
-   **採用理由**: ゲームワールドの状態をJSONファイルとしてエクスポートするセーブ機能 (`src/runtime/save-load.ts`) で使用されています。

### [uuid](https://github.com/uuidjs/uuid)
-   **役割**: 一意なIDの生成。
-   **概要**: RFC4122に準拠したUUIDを生成します。
-   **採用理由**: `src/domain/entity.ts`で定義されており、ECSにおける各エンティティに、衝突の可能性が極めて低い一意なIDを割り当てるために使用されます。

---

## 3. テスティング

### [Vitest](https://vitest.dev/)
-   **役割**: テストランナー。
-   **概要**: Viteネイティブの高速なテストフレームワーク。
-   **採用理由**:
    -   **高速性**: Viteのエンジンを活用し、テストの実行とフィードバックが非常に高速です。
    -   **設定の容易さ**: `vite.config.ts`を共有するため、テスト固有の複雑な設定が不要です。
    -   **Effectとの連携**: `Effect.runPromise`を使用することで、Effectで書かれたプログラムをユニットテスト内で簡単に実行できます（例: `src/runtime/world.test.ts`）。

### [fast-check](https://fast-check.dev/)
-   **役割**: プロパティベーステストライブラリ。
-   **概要**: 事前に定義したプロパティ（不変条件）に基づき、ランダムなデータを大量に自動生成してテストを実行します。
-   **採用理由**:
    -   **網羅性の向上**: `src/domain/components.test.ts`では、各コンポーネントスキーマが任意の有効なデータに対して正しくエンコード・デコードできることを保証するために使用されています。これにより、開発者が想定しないエッジケースを自動的に発見できます。

### [@vitest/ui](https://vitest.dev/guide/ui.html)
-   **役割**: インタラクティブなテストUI。
-   **概要**: テストの実行結果をブラウザ上で視覚的に確認できるUIを提供します。
-   **採用理由**: テストのフィルタリング、結果の分析、デバッグが容易になります。
