# PLAN 3: 型定義の全体的な改善計画

## 1. 目的

プロジェクト全体のコードベースに存在する `as`, `unknown`, `any` の使用を削減し、TypeScriptの静的型チェックの恩恵を最大化する。これにより、以下の達成を目指す。

- **コード品質の向上:** 型安全性を高め、可読性と保守性を向上させる。
- **バグの早期発見:** コンパイル時に潜在的な型関連のバグを検出し、ランタイムエラーを未然に防ぐ。
- **リファクタリングの容易化:** 型が明確になることで、コードの変更や機能追加を安全かつ効率的に行えるようにする。

## 2. 現状の問題点

`rg` コマンドによる調査の結果、プロジェクト内の多数のファイル（特に `src/runtime/world-pure.ts` やテストコード）で `as` による型アサーションや `any` 型が多用されていることが確認された。

これにより、部分的に型安全性が損なわれ、意図しない挙動やランタイムエラーを引き起こすリスクが高まっている。

## 3. 改善方針

`effect-ts` を全面的に採用し、副作用や非同期処理を安全に扱うことで、型定義の甘さを根本から解決する。

- **`Effect` による副作用の管理:**
  - ファイルI/O、DOM操作、非同期API呼び出しなど、副作用を伴う処理はすべて `Effect` でラップする。
  - `Effect<A, E, R>` を活用し、成功時の型 `A`、失敗時の型 `E`、および必要なコンテキスト `R` を明示する。
- **`any`, `unknown`, `as` の撲滅:**
  - `Effect` のパイプライン (`pipe`, `Effect.flatMap`, `Effect.map`) を活用し、型推論を最大限に活かすことで、これらの型を排除する。
  - 型が不明な値は `Schema` や `Parse` を使って安全にデコード・バリデーションする。
  - 型アサーションが必要な場面では、`Effect.fromEither` や `Effect.fromOption` を用いて、失敗する可能性を型で表現する。
- **エラーハンドリングの統一:**
  - `try...catch` 文を `Effect.try`, `Effect.catchAll`, `Effect.either` などに置き換え、エラーを型として扱う。
  - アプリケーション全体で一貫したエラー型を定義し、予期せぬ例外の発生を防ぐ。
- **依存性注入 (DI):**
  - `Context` と `Layer` を用いて、サービスや依存関係を管理する。
  - テスト時にはモック実装に差し替えることで、疎結合でテスト容易性の高い設計を実現する。

## 4. 作業計画

`Effect` の導入は影響範囲が広いため、アプリケーションのコア部分から段階的に進める。

### フェーズ1: ドメイン層とコアランタイムへの `Effect` 導入

- [ ] **`src/domain`**:
  - エンティティや値オブジェクトのバリデーションに `Schema` や `Either` を導入する。
  - ドメインロジック内のエラーを `Either` や `Option` で表現する。
- [ ] **`src/runtime/world-pure.ts`**:
  - ワールドの状態変更ロジックを `Effect` を返す関数にリファクタリングする。
  - `any` や `as` を撲滅し、`Effect` の型推論に任せる。
- [ ] **`src/runtime/world.ts`**:
  - `world-pure.ts` の `Effect` を実行するランナーを実装する。

### フェーズ2: システム層のリファクタリング

- [ ] **`src/systems`**:
  - 各システムを `Effect<void, E, R>` を返すプログラムとして再実装する。
  - システム間の依存関係を `Context` と `Layer` で管理する。
  - `block-interaction.ts`, `raycast.ts` など、副作用の多いシステムから着手する。

### フェーズ3: インフラストラクチャ層の `Effect` 化

- [ ] **`src/infrastructure`**:
  - Three.jsのAPI呼び出しやDOMイベントリスナーなど、外部ライブラリとの連携部分を `Effect.async` や `Effect.try` を使ってラップする。
  - `input-browser.ts`, `renderer-three/` が主な対象。

### フェーズ4: ワーカーとメインループの刷新

- [ ] **`src/workers/computation.worker.ts`**:
  - ワーカー内の処理を `Effect` で書き換え、メインスレッドとの通信を安全に行う。
- [ ] **`src/main.ts`**:
  - アプリケーション全体の `Effect` を構築し、`Effect.runPromise` で実行するエントリーポイントを再設計する。

### フェーズ5: テストコードの `Effect` 対応

- [ ] **`@effect/test` の活用**:
  - 既存の `vitest` テストを `@effect/test` を使ったテストに書き換える。
  - `TestClock`, `TestConsole` などを活用し、副作用をテスト内で安全に制御する。
  - `Layer.provide` を使ってテスト用のモックサービスを注入する。

## 5. 確認方法

各ファイルの修正後、以下のコマンドを実行して問題がないことを確認する。

1.  **TypeScriptコンパイルチェック:**
    ```bash
    pnpm tsc --noEmit
    ```
2.  **単体テストの実行:**
    ```bash
    pnpm test
    ```
3.  **リンターの実行:**
    ```bash
    pnpm lint
    ```
