# ディレクトリ構成 (Directory Structure)

プロジェクトのソースコードは `src/` ディレクトリ以下に配置され、責務に応じて明確に分割されています。この構成は、[関心の分離 (Separation of Concerns)](https://en.wikipedia.org/wiki/Separation_of_concerns) の原則に強く従っており、コードの保守性、再利用性、テスト容易性を高めることを目的としています。

```
src/
├── main.ts             # アプリケーションのエントリーポイント
├── domain/             # ドメインモデル（エンティティ、コンポーネント、アーキタイプ）
├── runtime/            # ゲームの実行環境（ワールド、ループ、サービス）
├── systems/            # ゲームロジック（ECSのシステム）
├── infrastructure/     # 外部ライブラリ・APIとの境界
└── utils/              # 汎用的なユーティリティ関数
```

---

## 各ディレクトリの詳細

### `main.ts`

アプリケーション全体の起動を担当するエントリーポイントです。
`Effect.Layer` を合成して、`Renderer` や `Input` といった各種サービスの具体的な実装（`infrastructure/`で定義）を依存関係として注入し、ゲームループを実行します。

### `domain/`

ゲーム世界の核となる概念（ドメインモデル）を定義するディレクトリです。フレームワークやライブラリに依存しない、純粋なデータ構造と型が含まれます。

-   **`entity.ts`**: `Entity` のブランド型など、エンティティに関連する型定義。
-   **`components.ts`**: `Position`, `Velocity` といった、すべてのコンポーネントのスキーマ (`@effect/schema`)。コンポーネントは純粋なデータであり、ロジックを持ちません。
-   **`archetypes.ts`**: エンティティを生成するためのファクトリ関数（プリファブ）を定義します。例えば `createPlayer` や `createBlock` のように、特定の役割を持つエンティティに必要なコンポーネント構成をカプセル化します。
-   **`block.ts`**: ブロックの種類 (`BlockType`) など、ブロックに特化したデータ構造を定義します。

### `runtime/`

ゲームを実行するための環境（ランタイム）を提供します。アプリケーションのコアとなる状態管理やサービスのインターフェース定義が含まれます。

-   **`world.ts`**: ECSの `World` の実装。エンティティとコンポーネントの集合を管理します。詳細は[Worldアーキテクチャ](./world.md)を参照。
-   **`scheduler.ts`**: システムの実行順序を依存関係に基づいて決定するスケジューラ。詳細は[システムスケジューラ](./system-scheduler.md)を参照。
-   **`loop.ts`**: ゲームループの `Effect` プログラム。`requestAnimationFrame` を利用して、フレームごとに全システムをスケジューラに従って実行します。
-   **`services.ts`**: アプリケーション全体で利用されるサービスのインターフェース（`Context.Tag`）を定義します。例えば `RenderContext` や `Input` のような、具体的な実装から独立したインターフェースを定義します。
-   **`save-load.ts`**: ゲームの状態をシリアライズ・デシリアライズするロジック。

### `systems/`

ECSアーキテクチャにおける **System** を実装するディレクトリです。各ファイルは単一の明確な責務を持ち、`World` からコンポーネントをクエリし、それらを操作してゲームのロジックを進行させます。

-   **`index.ts`**: すべてのシステムを `SystemNode` として定義し、それらの実行順序に関する依存関係（例: `physicsSystem` は `playerMovementSystem` の後に実行されるべき）を記述します。
-   **`player-movement.ts`**: ユーザー入力に基づき、プレイヤーエンティティの `Velocity` コンポーネントを更新します。
-   **`physics.ts`**: `Velocity` に基づいて `Position` を更新し、重力を適用します。
-   **`collision.ts`**: エンティティ間の衝突検知と応答を処理します。
-   **`generation.ts`**: `simplex-noise` を用いてプロシージャルに地形を生成します。
-   **`scene.ts`**: `Renderable` コンポーネントを持つエンティティを検出し、`RenderContext` を通じてレンダリングエンジンに描画コマンドを発行します。

### `infrastructure/`

外部の世界（ブラウザAPI、Three.jsなどのライブラリ）との具体的なやり取りを実装する層です。`runtime/services.ts` で定義されたインターフェースの具体的な実装を提供します。

-   **`renderer-three.ts`**: `ThreeJsContext` サービス。Three.jsのシーン、カメラ、レンダラーのインスタンスを管理します。
-   **`input-browser.ts`**: `Input` サービスのブラウザDOMイベントを用いた実装。キーボードやマウスの入力をリッスンします。
-   **`raycast-three.ts`**: `RaycastService` のThree.jsを用いた実装。マウスカーソルが指すブロックを特定するために使用します。
-   **`material-manager.ts`**: Three.jsのマテリアルとテクスチャを管理し、効率的な再利用を促します。

### `utils/`

特定のドメインに属さない、プロジェクト全体で再利用可能な汎用ユーティリティ関数を配置します。例えば、ベクトル計算、数値操作、データ構造のヘルパーなどが含まれます。