# ディレクトリ構成 (Directory Structure)

プロジェクトのソースコードは `src/` ディレクトリ以下に配置され、責務に応じて明確に分割されています。この構成は、[関心の分離 (Separation of Concerns)](https://en.wikipedia.org/wiki/Separation_of_concerns) の原則に強く従っており、コードの保守性、再利用性、テスト容易性を高めることを目的としています。

```
src/
├── main.ts             # アプリケーションのエントリーポイント
├── domain/             # ドメインモデル（エンティティ、コンポーネント）
├── runtime/            # ゲームの実行環境（ワールド、ループ、サービス）
├── systems/            # ゲームロジック（ECSのシステム）
├── infrastructure/     # 外部ライブラリ・APIとの境界
└── utils/              # 汎用的なユーティリティ関数
```

## アーキテクチャとデータフロー

本プロジェクトのアーキテクチャは、一方向の依存関係を基本としています。

`main.ts` -> `systems` -> `runtime` -> `domain`

- **`domain`**: 最も内側の層。ゲーム世界の核となる純粋なデータ構造を定義し、他のどの層にも依存しません。
- **`runtime`**: `domain`に依存。ゲームの状態（`World`）を管理し、外部とのやり取り（`Services`）を抽象的なインターフェースとして定義します。
- **`systems`**: `runtime`と`domain`に依存。`runtime`が提供するサービスを利用して、`World`内のコンポーネントを操作する具体的なゲームロジックを実装します。
- **`infrastructure`**: `runtime`のサービスインターフェースを実装する層。Three.jsやブラウザAPIといった具体的な技術に依存します。
- **`main.ts`**: 最も外側の層。すべての層を統合（DI）し、アプリケーションを起動します。

---

## 各ディレクトリの詳細

### `main.ts`

アプリケーション全体の起動を担当するエントリーポイントです。
主な責務は以下の通りです。

-   Effectの `Layer` を合成し、`infrastructure`層の実装を`runtime`層のインターフェースに注入（DI）することで、アプリケーションの依存関係を構築する。
-   ゲームループ `Effect` を構築し、実行する。
-   DOM要素をHTMLにアタッチする。

### `domain/`

ゲーム世界の核となる概念（ドメインモデル）を定義するディレクトリです。ここには、フレームワークやライブラリに依存しない、純粋なデータ構造と型が含まれます。

-   **`entity.ts`**: `Entity` のブランド型など、エンティティに関連する型定義。
-   **`components.ts`**: `Position`, `Velocity`, `Player` といった、エンティティの特性を定義するすべてのコンポーネントのスキーマ (`@effect/schema`)。
-   **`*.test.ts`**: `domain`の純粋なデータ構造や関数に対する単体テスト。

### `runtime/`

ゲームを実行するための環境（ランタイム）を提供するディレクトリです。ゲームの状態管理やメインループなど、ゲーム全体の動作を支える基盤がここに配置されます。

-   **`world.ts`**: ECSの `World` の実装。すべてのエンティティとコンポーネントの状態を保持し、それらを安全に操作するためのAPIを提供します。
-   **`loop.ts`**: ゲームループの `Effect` プログラム。入力のポーリング、全システムの実行、レンダリングという一連の流れを定義します。
-   **`services.ts`**: `Renderer`, `Input`, `MaterialManager` といった、アプリケーション全体で利用されるサービスのインターフェース（`Context` Tag）を定義します。これらのインターフェースは `infrastructure` 層で実装されます。
-   **`game-state.ts`**: ゲームの全体的な状態（例: `Title`, `InGame`, `Paused`）を管理します。
-   **`save-load.ts`**: セーブデータのスキーマ定義と、シリアライズ/デシリアライズ処理を担当します。

### `systems/`

ECSアーキテクチャにおける **System** を実装するディレクトリです。各ファイルが特定の関心事（物理、描画、プレイヤー制御など）に対するロジックを担当します。システムは `Effect` プログラムとして実装され、`runtime/` のサービスを利用して `World` の状態を読み取り、次の状態を計算します。

-   **`physics.ts`**: 重力、速度、衝突検知などの物理計算。
-   **`render.ts`**: `World` の状態を読み取り、`Renderer` サービスに描画コマンドを発行する。
-   **`player.ts`**: プレイヤーの入力に基づき、プレイヤーエンティティの状態を更新する。
-   **`generation.ts`**: ワールドの地形をプロシージャルに生成する。
-   **`chunk-loading.ts`**: プレイヤーの周囲のチャンクを管理する。
-   **`interaction.ts`**: ブロックの設置や破壊のロジック。
-   **`ui.ts`**: HUDやメニューの表示を制御する。
-   **`index.ts`**: すべてのシステムを合成し、実行順序を定義した単一の `Effect` (`mainSystem`) としてエクスポートします。これにより、ゲームループ内でのシステムの実行順序が保証されます。

### `infrastructure/`

外部の世界（ブラウザAPI、ライブラリなど）との具体的なやり取りを実装する層です。`runtime/services.ts` で定義されたインターフェースの具体的な実装を提供します。この層のおかげで、例えばレンダリングエンジンをThree.jsから別のものに交換する場合でも、変更箇所をこのディレクトリ内に限定できます。

-   **`renderer-three.ts`**: `Renderer` サービスの Three.js を用いた実装。
-   **`input-browser.ts`**: `Input` サービスのブラウザDOMイベントを用いた実装。
-   **`ui.ts`**: DOM操作によるUIの具体的な描画処理。
-   **`material-manager.ts`**: Three.js のマテリアルを管理する実装。

### `utils/`

特定のドメインに依存しない、汎用的なヘルパー関数や定数を配置します。（現在は空ですが、将来的な拡張のために予約されています。）