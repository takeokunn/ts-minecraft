# ディレクトリ構成 (Directory Structure)

プロジェクトのソースコードは `src/` ディレクトリ以下に配置され、責務に応じて明確に分割されています。この構成は、[関心の分離 (Separation of Concerns)](https://en.wikipedia.org/wiki/Separation_of_concerns) の原則に強く従っており、コードの保守性、再利用性、テスト容易性を高めることを目的としています。

# ディレクトリ構成 (Directory Structure)

プロジェクトのソースコードは `src/` ディレクトリ以下に配置され、責務に応じて明確に分割されています。この構成は、[関心の分離 (Separation of Concerns)](https://en.wikipedia.org/wiki/Separation_of_concerns) の原則に強く従っており、コードの保守性、再利用性、テスト容易性を高めることを目的としています。

```
src/
├── main.ts             # アプリケーションのエントリーポイント
├── domain/             # ドメインモデル（エンティティ、コンポーネント、ブロック定義）
├── runtime/            # ゲームの実行環境（ワールド、ループ、サービス、スケジューラ）
├── systems/            # ゲームロジック（ECSのシステム）
├── infrastructure/     # 外部ライブラリ・APIとの境界
└── utils/              # 汎用的なユーティリティ関数
```

## アーキテクチャとデータフロー

本プロジェクトのアーキテクチャは、一方向の依存関係を基本としています。

**`main.ts` -> `systems` -> `runtime` -> `domain`**

- **`domain`**: 最も内側の層。ゲーム世界の核となる純粋なデータ構造を定義し、他のどの層にも依存しません。
- **`runtime`**: `domain`に依存。ゲームの状態（`World`）を管理し、外部とのやり取り（`Services`）を抽象的なインターフェースとして定義します。
- **`systems`**: `runtime`と`domain`に依存。`runtime`が提供するサービスを利用して、`World`内のコンポーネントを操作する具体的なゲームロジックを実装します。
- **`infrastructure`**: `runtime`のサービスインターフェースを実装する層。Three.jsやブラウザAPIといった具体的な技術に依存します。
- **`main.ts`**: 最も外側の層。すべての層を統合（DI）し、アプリケーションを起動します。

---

## 各ディレクトリの詳細

### `main.ts`

アプリケーション全体の起動を担当するエントリーポイントです。
主な責務は以下の通りです。

-   Effectの `Layer` を合成し、`infrastructure`層の実装を`runtime`層のインターフェースに注入（DI）することで、アプリケーションの依存関係を構築する。
-   ゲームループの `Effect` プログラムを構築し、実行する。
-   Three.jsのレンダラーやUIのDOM要素をHTMLにアタッチする。

### `domain/`

ゲーム世界の核となる概念（ドメインモデル）を定義するディレクトリです。ここには、フレームワークやライブラリに依存しない、純粋なデータ構造と型が含まれます。

-   **`entity.ts`**: ECSの `EntityId` を定義します。これはUUIDv4に基づくブランド型であり、型安全性を保証します。
-   **`components.ts`**: `Position`, `Velocity`, `Player` といった、エンティティの特性を定義するすべてのコンポーネントのスキーマを `@effect/schema` の `Schema.Class` を用いて定義します。これにより、静的型とランタイムのバリデーションが同時に得られます。
-   **`block.ts`**: `Grass`, `Stone` などのブロックの種類(`BlockType`)と、そのテクスチャや属性などのメタデータを定義します。

### `runtime/`

ゲームを実行するための環境（ランタイム）を提供するディレクトリです。ゲームの状態管理やメインループなど、ゲーム全体の動作を支える基盤がここに配置されます。

-   **`world.ts`**: ECSの `World` の実装。すべてのエンティティとコンポーネントの状態を、パフォーマンスに最適化された **Structure of Arrays (SoA)** 形式で保持します。エンティティのCRUD操作やクエリ機能を提供します。詳細は[Worldアーキテクチャ](./world.md)を参照してください。
-   **`scheduler.ts`**: システムの実行順序を依存関係に基づいて決定するスケジューラ。`systems/index.ts` で定義された `SystemNode` のリストを受け取り、トポロジカルソートして単一の `Effect` に合成します。詳細は[システムスケジューラ](./system-scheduler.md)を参照してください。
-   **`loop.ts`**: ゲームループの `Effect` プログラム。入力のポーリング、全システムの実行、レンダリングという一連の流れを定義します。
-   **`services.ts`**: `Renderer`, `Input`, `MaterialManager` といった、アプリケーション全体で利用されるサービスのインターフェースを `Effect` の `Context.Tag` を用いて定義します。これらのインターフェースは `infrastructure` 層で実装されます。
-   **`game-state.ts`**: ゲームの全体的な状態（例: `Title`, `InGame`, `Paused`）を管理する `Ref` を提供します。
-   **`save-load.ts`**: セーブデータのスキーマ定義と、シリアライズ/デシリアライズ処理を担当します。

### `systems/`

ECSアーキテクチャにおける **System** を実装するディレクトリです。各ファイルが単一の明確な責務（物理、プレイヤー制御、描画など）に対するロジックを担当します。Systemは `Effect.Effect<void, never, World>` という型の `Effect` プログラムとして実装されます。

-   **`player.ts`**: プレイヤーの入力に基づき、移動やジャンプの **意図** を`Velocity`コンポーネントに変換します。
-   **`physics.ts`**: `Gravity` コンポーネントを持つエンティティに重力を適用し、`Velocity` を更新します。
-   **`collision.ts`**: `Collider` を持つエンティティと地形との衝突検知を行い、`Position` を補正します。
-   ... (その他システムファイル)
-   **`index.ts`**: すべてのシステムを `SystemNode` として定義し、それらの依存関係（`after`プロパティ）を記述します。これらの定義は `runtime/scheduler.ts` に渡され、最終的に実行可能な単一の `Effect` (`mainSystem`) としてエクスポートされます。

### `infrastructure/`

外部の世界（ブラウザAPI、ライブラリなど）との具体的なやり取りを実装する層です。`runtime/services.ts` で定義されたインターフェースの具体的な実装を提供します。この層のおかげで、例えばレンダリングエンジンをThree.jsから別のものに交換する場合でも、変更箇所をこのディレクトリ内に限定できます。

-   **`renderer-three.ts`**: `Renderer` サービスの Three.js を用いた実装。ECSの `World` を監視し、シーンの変更をThree.jsのオブジェクトに反映させます。
-   **`input-browser.ts`**: `Input` サービスのブラウザDOMイベントを用いた実装。キーボードやマウスの入力を検知し、`InputState` コンポーネントを更新します。
-   **`ui.ts`**: DOM操作によるUI（ホットバー、クロスヘアなど）の具体的な描画・更新処理。
-   **`material-manager.ts`**: Three.js のマテリアル（テクスチャ）を管理する実装。

### `utils/`

特定のドメインに依存しない、汎用的なヘルパー関数や定数を配置します。（現在は空ですが、将来的な拡張のために予約されています。）


## アーキテクチャとデータフロー

本プロジェクトのアーキテクチャは、一方向の依存関係を基本としています。

`main.ts` -> `systems` -> `runtime` -> `domain`

- **`domain`**: 最も内側の層。ゲーム世界の核となる純粋なデータ構造を定義し、他のどの層にも依存しません。
- **`runtime`**: `domain`に依存。ゲームの状態（`World`）を管理し、外部とのやり取り（`Services`）を抽象的なインターフェースとして定義します。
- **`systems`**: `runtime`と`domain`に依存。`runtime`が提供するサービスを利用して、`World`内のコンポーネントを操作する具体的なゲームロジックを実装します。
- **`infrastructure`**: `runtime`のサービスインターフェースを実装する層。Three.jsやブラウザAPIといった具体的な技術に依存します。
- **`main.ts`**: 最も外側の層。すべての層を統合（DI）し、アプリケーションを起動します。

---

## 各ディレクトリの詳細

### `main.ts`

アプリケーション全体の起動を担当するエントリーポイントです。
主な責務は以下の通りです。

-   Effectの `Layer` を合成し、`infrastructure`層の実装を`runtime`層のインターフェースに注入（DI）することで、アプリケーションの依存関係を構築する。
-   ゲームループ `Effect` を構築し、実行する。
-   DOM要素をHTMLにアタッチする。

### `domain/`

ゲーム世界の核となる概念（ドメインモデル）を定義するディレクトリです。ここには、フレームワークやライブラリに依存しない、純粋なデータ構造と型が含まれます。

-   **`entity.ts`**: `Entity` のブランド型など、エンティティに関連する型定義。
-   **`components.ts`**: `Position`, `Velocity`, `Player` といった、エンティティの特性を定義するすべてのコンポーネントのスキーマ (`@effect/schema`)。
-   **`*.test.ts`**: `domain`の純粋なデータ構造や関数に対する単体テスト。

### `runtime/`

ゲームを実行するための環境（ランタイム）を提供するディレクトリです。ゲームの状態管理やメインループなど、ゲーム全体の動作を支える基盤がここに配置されます。

-   **`world.ts`**: ECSの `World` の実装。すべてのエンティティとコンポーネントの状態を、パフォーマンスに最適化された **Structure of Arrays (SoA)** 形式で保持します。詳細は[Worldアーキテクチャ](./world.md)を参照してください。
-   **`scheduler.ts`**: システムの実行順序を依存関係に基づいて決定するスケジューラ。詳細は[システムスケジューラ](./system-scheduler.md)を参照してください。
-   **`loop.ts`**: ゲームループの `Effect` プログラム。入力のポーリング、全システムの実行、レンダリングという一連の流れを定義します。
-   **`services.ts`**: `Renderer`, `Input`, `MaterialManager` といった、アプリケーション全体で利用されるサービスのインターフェース（`Context` Tag）を定義します。これらのインターフェースは `infrastructure` 層で実装されます。
-   **`game-state.ts`**: ゲームの全体的な状態（例: `Title`, `InGame`, `Paused`）を管理します。
-   **`save-load.ts`**: セーブデータのスキーマ定義と、シリアライズ/デシリアライズ処理を担当します。

### `systems/`

ECSアーキテクチャにおける **System** を実装するディレクトリです。各ファイルが単一の明確な責務（物理、プレイヤー制御、描画など）に対するロジックを担当します。

-   **`player.ts`**: プレイヤーの入力に基づき、移動やジャンプの **意図** を`Velocity`コンポーネントに変換します。
-   **`physics.ts`**: すべてのエンティティに重力を適用し、垂直方向の速度を更新します。
-   ... (その他システムファイル)
-   **`index.ts`**: すべてのシステムを `SystemNode` として定義し、それらの依存関係（`after`プロパティ）を記述します。これらの定義は `runtime/scheduler.ts` に渡され、最終的に実行可能な単一の `Effect` (`mainSystem`) としてエクスポートされます。

### `infrastructure/`

外部の世界（ブラウザAPI、ライブラリなど）との具体的なやり取りを実装する層です。`runtime/services.ts` で定義されたインターフェースの具体的な実装を提供します。この層のおかげで、例えばレンダリングエンジンをThree.jsから別のものに交換する場合でも、変更箇所をこのディレクトリ内に限定できます。

-   **`renderer-three.ts`**: `Renderer` サービスの Three.js を用いた実装。
-   **`input-browser.ts`**: `Input` サービスのブラウザDOMイベントを用いた実装。
-   **`ui.ts`**: DOM操作によるUIの具体的な描画処理。
-   **`material-manager.ts`**: Three.js のマテリアルを管理する実装。

### `utils/`

特定のドメインに依存しない、汎用的なヘルパー関数や定数を配置します。（現在は空ですが、将来的な拡張のために予約されています。）