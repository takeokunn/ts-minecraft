---
title: "レイヤードアーキテクチャ"
description: "レイヤードアーキテクチャに関する詳細な説明とガイド。"
category: "architecture"
difficulty: "advanced"
tags: ['typescript', 'minecraft', 'architecture']
prerequisites: ['basic-typescript', 'effect-ts-fundamentals']
estimated_reading_time: "10分"
last_updated: "2025-09-14"
version: "1.0.0"
---

# 4層アーキテクチャ

TypeScript Minecraftプロジェクトは、DDD（ドメイン駆動設計）の原則に基づき、明確に分離された4つのレイヤーで構成されています。これにより、関心事の分離、保守性、テスト容易性を高めています。

```
┌───────────────────────────────────┐
│        プレゼンテーション層         │  ← ユーザーインターフェース、入力処理
├───────────────────────────────────┤
│        アプリケーション層          │  ← ユースケース、ワークフロー制御
├───────────────────────────────────┤
│          ドメイン層            │  ← ビジネスロジック、エンティティ、値オブジェクト
├───────────────────────────────────┤
│       インフラストラクチャ層       │  ← 外部システム連携（DB, API, レンダリング）
└───────────────────────────────────┘
```

---

## 1. ドメイン層 - ビジネスロジック・コアドメイン

**責務:** ゲームの核となるビジネスルールとドメインロジックを表現します。このレイヤーは他のどのレイヤーにも依存せず、純粋なビジネスロジックに集中します。

**主要な構成要素:**
- **エンティティ (Entities):** `Player`, `World`, `Chunk`, `Block` など、一意なIDを持つビジネスオブジェクト。
- **値オブジェクト (Value Objects):** `Position`, `Velocity`, `AABB` など、不変で属性によって識別されるオブジェクト。
- **ドメインサービス (Domain Services):** 特定のエンティティに属さない、複雑なビジネスロジック。
- **ポート (Ports):** インフラストラクチャ層が実装すべきインターフェース定義（依存性逆転）。
- **ドメインイベント (Domain Events):** ドメイン内で発生した重要な事象。

**実装原則:**
- **純粋性:** すべてのロジックは純粋関数として実装。
- **不変性:** データ構造はすべて不変。
- **型安全性:** `Schema.Struct` を用いて厳密な型定義とバリデーションを行う。
- **通常の`class`完全排除:** `Schema.Struct`と純粋関数の組み合わせで実装（`Schema.TaggedError`のみ例外）。

---

## 2. アプリケーション層 - ユースケース実装とワークフロー

**責務:** ドメイン層のビジネスロジックを組み合わせて、具体的なユースケース（例: プレイヤーの移動、ブロックの設置）を実現します。

**主要な構成要素:**
- **ユースケース (Use Cases):** `PlayerMoveUseCase`, `BlockPlaceUseCase` など、単一のビジネス機能。
- **ワークフロー (Workflows):** `ChunkLoadingWorkflow` など、複数のユースケースを組み合わせた複合処理。
- **クエリシステム (Query System):** ECSと連携し、効率的なデータ検索を行う。
- **コマンドパターン (Command Pattern):** 操作の実行、取り消し、再実行を管理。

**実装原則:**
- **ドメイン層のオーケストレーション:** ドメインサービスやエンティティを呼び出し、ビジネスフローを制御。
- **トランザクション管理:** 操作の一貫性を保証。
- **関心事の分離:** UIや外部システムへの関心を持たない。

---

## 3. インフラストラクチャ層 - 技術詳細・外部システム連携

**責務:** 外部の技術的な詳細を実装し、ドメイン層で定義されたポート（インターフェース）を具現化します。

**主要な構成要素:**
- **アダプター (Adapters):** `Three.js`, `WebGPU`, ブラウザAPIなどの外部ライブラリとの連携部分。
- **リポジトリ (Repositories):** `IndexedDB`などを用いたデータ永続化の実装。
- **Web Workers:** `mesh-generation`, `terrain-generation`など、重い処理をバックグラウンドで実行。
- **パフォーマンス最適化:** メモリプール、キャッシュ戦略など。

**実装原則:**
- **依存性逆転:** ドメイン層のポートに依存し、具体的な実装を提供。
- **技術的詳細の隠蔽:** 上位レイヤーが特定の技術に依存しないように抽象化。
- **エラー変換:** 外部ライブラリのエラーをドメインエラーに変換。

---

## 4. プレゼンテーション層 - ユーザーインターフェース・制御

**責務:** ユーザーとのインタラクションを担当し、UIの表示とユーザー入力の処理を行います。

**主要な構成要素:**
- **コントローラー (Controllers):** ユーザー入力を受け取り、アプリケーション層のユースケースを呼び出す。
- **ビューモデル (View Models):** UIの状態を管理し、データバインディングを提供。
- **CLIツール:** 開発者向けのデバッグコマンドやインスペクター。
- **Webエントリーポイント:** ブラウザ環境でのアプリケーション初期化とレンダリングループ。

**実装原則:**
- **MVVMパターン:** Model-View-ViewModelパターンを採用し、UIロジックとビジネスロジックを分離。
- **リアクティブUI:** ビューモデルの状態変更が自動的にUIに反映される仕組み。
- **シーン管理:** `StartScreen`, `MainGame`, `GameOver`などのシーン遷移を制御。

---

## 5. 共有層 - 共通ライブラリ・ユーティリティ

**責務:** すべてのレイヤーで共有される、プロジェクト横断的な機能を提供します。

**主要な構成要素:**
- **型定義 (Types):** `EntityID`, `Position`などの共通の型やスキーマ。
- **定数 (Constants):** `CHUNK_SIZE`, `GRAVITY`などの物理定数やゲーム設定。
- **ユーティリティ (Utils):** 数学計算、関数型プログラミングのヘルパーなど。

**実装原則:**
- **汎用性:** 特定のレイヤーに依存しない、再利用可能な機能を提供する。
- **一貫性:** プロジェクト全体で共通の規約やパターンを強制する。