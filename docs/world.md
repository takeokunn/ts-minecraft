# World

このセクションでは、ゲーム世界の中心的な概念である`World`に関するドキュメントをまとめています。`World`は、ゲーム内のすべてのエンティティ（キャラクター、ブロック、アイテムなど）と、それらの状態（位置、速度、体力など）を一元管理するコンテナです。

---

## 1. World サービス API

`World` サービスは、ECS（Entity Component System）アーキテクチャの中核をなす存在であり、ゲーム内に存在するすべてのエンティティとコンポーネントの状態を一元管理する、唯一の信頼できる情報源（Source of Truth）です。

> `World`の内部的な設計思想（Archetype, SoA）やパフォーマンスに関する詳細については、[**World内部設計 (World Architecture)**](./world-performance.md) を参照してください。

### 責務と実装

- **責務**:
  - すべてのエンティティとコンポーネントの状態を効率的に保持する。
  - 状態の読み取り（クエリ）と変更（作成、更新、削除）のための、安全で型安全なAPIを提供する。
- **実装**:
  - `World` サービスの実体は、Effectの `Ref<WorldState>` です。`Ref` はアトミックな更新が可能な可変参照であり、複数のシステムから同時にアクセスされても状態の整合性を保ちます。

### 主要API

`World` サービスと対話するための操作は、`src/domain/world.ts` 内でEffectとして定義されています。

- **`addArchetype(archetype)`**: `Archetype` オブジェクトに基づいて新しいエンティティをワールドに追加し、その `EntityId` を返します。
- **`removeEntity(id)`**: 指定されたエンティティをワールドから完全に削除します。
- **`getComponent(entityId, component)`**: エンティティから特定のコンポーネントを `Option` として取得します。
- **`updateComponent(entityId, component)`**: エンティティの特定のコンポーネントを新しいデータで更新します。
- **`query(queryDef)`**: `Query` オブジェクトにマッチするすべてのエンティティとそのコンポーネントのリスト（AoS形式）を取得します。
- **`querySoA(queryDef)`**: `query` と同様ですが、結果をパフォーマンスに最適化されたSoA (Structure of Arrays) 形式で返します。**GC負荷を最小限に抑えるため、原則として常にこのAPIを使用してください。**
- **`modify(f)`**: `World` の内部状態 (`WorldState`) をアトミックに変更し、結果を返すための低レベルAPIです。
- **`update(f)`**: `modify` と同様ですが、結果を返しません。

---

## 2. ワールドのライフサイクル

ゲームワールドは静的なものではなく、プレイヤーの行動に応じて動的に生成、更新、破棄されます。このセクションでは、そのライフサイクルを管理する主要なシステムについて解説します。

### ワールド生成 (World Generation)

ワールド生成は、プレイヤーが探検するゲーム世界の地形をプロシージャル（手続き的）に生成するプロセスです。Simplex Noiseを利用して、再現可能でありながら無限に広がる、自然で変化に富んだ景観を創造します。

この処理は計算負荷が非常に高いため、メインスレッドをブロックしないようWeb Worker (`src/workers/computation.worker.ts`) 内で完全に非同期に実行されます。

#### 責務

`computation.worker.ts` は、メインスレッドからチャンク座標とワールド生成パラメータを受け取り、以下の2つの主要な成果物を計算して返す責務を担います。

1.  **ブロックデータ (`BlockData[]`)**: そのチャンクを構成するすべてのブロックの種類と位置のリスト。
2.  **メッシュデータ (`Mesh`)**: レンダリングのために最適化された、チャンクの可視ジオメトリ（頂点、法線、UV、インデックス）。

#### 生成プロセス

1.  **ブロックデータの生成**: ノイズ関数を用いて、チャンク内のどの座標にどの種類のブロックが存在するかを決定します。地形の高さ、バイオーム、木の配置などが計算され、プレイヤーによる変更（破壊・設置）も反映されます。
2.  **メッシュデータの生成 (Greedy Meshing)**: 生成されたブロックデータをそのままレンダリングするとパフォーマンスが著しく低下するため、**Greedy Meshing** アルゴリズムを用いて、描画に必要なジオメトリを劇的に削減します。隣接する同じ種類のブロックを検出し、それらを一つの大きな面に統合することで、頂点数とドローコールを90%以上削減します。

### チャンクロードシステム (Chunk Loading System)

- **関連ソース**: [`src/systems/chunk-loading.ts`](../../src/systems/chunk-loading.ts)
- **責務**: プレイヤーの位置を監視し、描画範囲に基づいてチャンクのロード（地形生成の依頼）とアンロード（エンティティの削除）を判断すること。

#### 概要

このシステムは、プレイヤーの位置に基づいてワールドの一部（チャンク）を動的にストリーミングする、パフォーマンス上極めて重要な機能です。プレイヤーがチャンク境界を越えたタイミングを検知し、どのチャンクを新たにロードし、どのチャンクをアンロードすべきかを計算します。

#### 処理フロー

1.  **チャンク移動検知**: プレイヤーが新しいチャンクに移動したかどうかをチェックします。
2.  **ロード/アンロード対象の計算**: 現在いるべきチャンクのセットと、すでにロードされているチャンクのセットを比較し、ロードすべきチャンクとアンロードすべきチャンクのリストを作成します。
3.  **コマンド発行とWorld更新**:
    - ロード対象のチャンクに対して `GenerateChunk` コマンドを発行します。
    - アンロード対象のチャンクエンティティを `World` から削除します。

### ワールド更新システム (World Update System)

- **関連ソース**: [`src/systems/world-update.ts`](../../src/systems/world-update.ts)
- **責務**: バックグラウンドのWeb Workerで生成されたチャンクデータを、メインスレッド上の `World` とレンダリングエンジンに反映させること。

#### 概要

このシステムは、非同期の計算結果をゲームのメインループに統合するための重要な橋渡し役です。

#### 処理フロー

1.  **データ受信**: `ChunkDataQueue` を監視し、Workerが完了したチャンク生成タスクの結果を1フレームに1つだけ取り出します。
2.  **ワールド状態の更新**: 受け取ったブロックデータに基づき、`World` に新しいブロックエンティティを生成します。
3.  **レンダリングの依頼**: 受け取ったメッシュデータを `RenderQueue` に送信し、レンダリングエンジンにチャンクのジオメトリの生成・更新を依頼します。

#### データフロー

`chunkLoadingSystem` -> `Computation Service (Worker)` -> `ChunkDataQueue` -> **`worldUpdateSystem`** -> `World` & `RenderQueue` -> `RendererThree`

---

## 3. セーブ & ロード (Save & Load)

この機能は、ゲームの状態を保存し、後で復元するためのシステムです。

### 設計思想

- **再現性**: セーブデータには、ワールドを完全に同じ状態で再現するための最小限の情報のみ（ワールド生成シードとプレイヤーによる変更の差分）を格納します。
- **スキーマ駆動**: `@effect/schema` を用いてセーブデータの構造を厳密に定義し、安全なデシリアライズを保証します。
- **外部ファイルベース**: セーブデータは `save.json` ファイルとしてユーザーが管理します。

### セーブデータ (`SaveState`) の構造

- **`seed`**: ワールド生成に使用されたシード値。
- **`player`**: プレイヤーの `Position` と `CameraState`。
- **`editedBlocks`**: プレイヤーによって変更されたブロックの差分データ。

### セーブのプロセス (`saveGame` Effect)

1.  **データ収集**: 現在の `seed`、プレイヤーの `Position` と `CameraState`、そして `editedBlocks` を取得します。
2.  **エンコードとダウンロード**: データを `SaveState` スキーマに準拠したJSONにエンコードし、`save.json` としてダウンロードさせます。

### ロードのプロセス (`loadGame` Effect)

1.  **ファイル読み込みとデコード**: `save.json` を読み込み、`SaveState` スキーマで検証・デコードします。
2.  **ゲーム状態の復元**:
    - デコードした `seed` と `editedBlocks` を使ってワールドをプロシージャルに再生成します。
    - プレイヤーを保存された `Position` と `CameraState` に配置します。
3.  **ゲーム開始**: ロードされたワールドでゲームを開始します。
