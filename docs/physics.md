# 物理エンジン

このドキュメントでは、ゲームワールド内のエンティティに物理的な挙動を与えるためのシステム群について解説します。これらのシステムは連携して、重力、摩擦、衝突検知、衝突解決といった基本的な物理法則をシミュレートします。

物理演算は、以下の3つの主要なシステムによって、明確に分離されたステップで実行されます。

1.  **`physicsSystem`**: 重力と摩擦を適用し、エンティティの「暫定的な」次の位置を計算します。
2.  **`updatePhysicsWorldSystem`**: 衝突検知を高速化するためのデータ構造（空間グリッド）を最新の状態に更新します。
3.  **`collisionSystem`**: 暫定的な位置に衝突がないか検証し、あれば位置を補正して最終的な位置を確定させます。

---

## 1. 物理システム (Physics System)

- **関連ソース**: [`src/systems/physics.ts`](../../src/systems/physics.ts)
- **責務**: エンティティに物理法則（重力、摩擦）を適用し、その結果に基づいてエンティティの位置を更新すること。

### 概要

`physicsSystem` は、ゲームワールド内のエンティティに基本的な物理演算を適用します。この計算はフレームレートに依存しないように、前フレームからの経過時間（`DeltaTime`）を考慮して行われます。

このシステムが計算した位置は「暫定的な」ものであり、最終的な位置は後続の `collisionSystem` によって衝突解決が行われた後に確定します。

### アーキテクチャ

`physicsSystem` は `Effect.Effect<void, E, R>` として実装された `Effect` プログラムです。

- **依存性の注入**: `World` サービスと `DeltaTime` サービスを `Effect` のコンテキストを通じて受け取ります。
- **状態の更新**: `world.querySoA` を使ってコンポーネントの配列への直接参照を取得し、状態を効率的に更新します。

### 処理フロー

1.  **クエリ実行**:
    - `physicsQuery` を使用して、物理演算に必要なコンポーネント（`position`, `velocity`, `gravity`, `player`）を持つエンティティのデータを `querySoA` で取得します。

2.  **物理計算**:
    - ループ処理で各エンティティのコンポーネントを更新します。
    - **重力の適用**:
      - エンティティが接地していない（`isGrounded` が `false`）場合、`Velocity` の `dy` 成分に重力を適用します。落下速度が `TERMINAL_VELOCITY`（終端速度）を超えないように制限されます。
    - **摩擦の適用**:
      - エンティティが接地している（`isGrounded` が `true`）場合、水平方向の速度 (`dx`, `dz`) に `FRICTION`（摩擦係数）を乗算し、スムーズに減速させます。
    - **位置の更新**:
      - 上記の計算で更新された最終的な速度 (`newDx`, `newDy`, `newDz`) に `deltaTime` を乗算し、現在の `Position` に加算します。これにより、フレームレートの変動に関わらず、物理挙動が一貫性を保ちます。

3.  **コンポーネントの更新**:
    - 計算された新しい速度と位置を、`querySoA` で取得したコンポーネント配列に直接書き込みます。

---

## 2. 空間グリッド更新システム (updatePhysicsWorldSystem)

- **関連ソース**: `src/systems/update-physics-world.ts`
- **責務**: **`SpatialGrid` サービス内の空間グリッドを、現在のフレームにおけるエンティティの最新の位置情報で更新すること**。

### 概要

`updatePhysicsWorldSystem` は、物理エンジン、特に衝突検知システムの効率と正確性を維持するための、フレームごとのハウスキーピング（整理）システムです。

`SpatialGrid` サービスは、広域衝突検知（Broad-Phase Collision Detection）を高速化するために、エンティティの位置をグリッド構造で管理しています。あるエンティティの衝突をチェックする際、ワールド内のすべてのエンティティと総当たりで比較するのではなく、そのエンティティが属するグリッドセルと、その周辺のセルに存在するエンティティのみを候補とすることで、計算量を大幅に削減します。

しかし、エンティティは毎フレーム移動するため、この空間グリッドの情報はすぐに古くなってしまいます。`updatePhysicsWorldSystem` は、この情報を最新の状態に保つ役割を担います。

### 処理フロー

1.  **クリア**: まず、`spatialGrid.clear()` を呼び出し、前のフレームの空間グリッド情報をすべて消去します。
2.  **クエリ**: `world.querySoA` と共通クエリ `positionColliderQuery` を使用して、`Position` と `Collider` の両方を持つすべてのエンティティの最新データを効率的に一括取得します。
3.  **再登録**:
    - クエリ結果をループ処理し、各エンティティの `Position` と `Collider` の情報から、そのフレームでの正確なAABB（最小・最大のXYZ座標）を計算します。
    - 計算したAABBとエンティティIDを `spatialGrid.register(entityId, aabb)` に渡して空間グリッドに再登録します。

---

## 3. 衝突検知・解決システム (Collision System)

- **関連ソース**: [`src/systems/collision.ts`](../../src/systems/collision.ts)
- **責務**: エンティティの位置を検証し、衝突を解決すること。

### 概要

衝突検知・解決システムは、エンティティがワールド内の地形（ブロック）を通り抜けることなく、物理的に正しく相互作用することを保証する重要な機能です。`physicsSystem` によって計算された移動を検証し、衝突が発生した場合にはエンティティの位置を補正する責務を担います。このシステムはエンティティを能動的に移動させるのではなく、`physicsSystem` によってすでに行われた移動の「結果」を補正します。

### 処理フロー

1.  **データ取得**: `world.querySoA` を使用して、衝突判定の対象となるプレイヤーと、衝突される可能性のある地形ブロックのSoAストアへの参照をそれぞれ取得します。
2.  **広域衝突検知 (Broad-Phase)**:
    - `SpatialGrid` サービスにプレイヤーの周囲のAABBを問い合わせ、衝突の可能性がある近隣エンティティのIDリストを効率的に取得します。これにより、ワールド内のすべてのブロックをチェックする無駄を省きます。
3.  **近隣エンティティのAABB構築**:
    - 広域検知で得られたエンティティIDのリストを使い、地形ブロックのSoAストアからデータを読み取り、衝突候補となるエンティティのAABB（軸並行境界ボックス）のリストを構築します。
4.  **狭域衝突解決 (Narrow-Phase)**:
    - 衝突解決は、**Y軸（垂直方向）**、**X軸（水平方向）**、**Z軸（水平方向）**の順で、軸ごとに独立して行われます。この軸分離（Axis Separation）が、壁に沿ってスムーズに滑るような自然な挙動を実現するために重要です。
    - 各軸で、プレイヤーのAABBと近隣ブロックのAABBとの間で交差をチェックします。
    - 交差が検出された場合、プレイヤーの位置をブロックの表面にぴったりと接するように補正し、対応する速度成分を `0` にリセットします。
    - エンティティが下向きに移動中にY軸の衝突が発生した場合、`Player` コンポーネントの `isGrounded` フラグを `true` に設定します。
5.  **コンポーネントストアの更新**: すべての軸で衝突解決が完了した後、最終的に補正された位置、速度、接地状態を、対応するSoAストアに直接書き込みます。

---

## 実行順序

物理システムの実行順序は、ゲームのシミュレーションにおいて極めて重要です。

`playerMovementSystem` -> **`physicsSystem`** -> **`updatePhysicsWorldSystem`** -> **`collisionSystem`**

1.  **`playerMovementSystem`**: プレイヤーの移動やジャンプの「意図」を決定し、`Velocity` を更新します。
2.  **`physicsSystem`**: `playerMovementSystem` によって設定された `Velocity` に重力と摩擦を適用し、`Position` を暫定的に更新します。
3.  **`updatePhysicsWorldSystem`**: `physicsSystem` によって更新された `Position` に基づいて `SpatialGrid` を最新の状態にします。
4.  **`collisionSystem`**: `updatePhysicsWorldSystem` によって更新された暫定的な `Position` を検証し、衝突があれば位置を補正して最終的な位置を「確定」させます。
