# sceneSystem: レンダリングパイプライン

`sceneSystem` は、抽象的でデータ指向なECSワールドと、Three.jsによって描画される視覚的表現とを結びつける、極めて重要なシステムです。その主な責務は、ECS内の描画可能なエンティティの状態を、Three.jsシーン内の対応するオブジェクトと効率的に同期させることです。

---

## 責務

`sceneSystem` の唯一の責務は、**現在のゲームワールドの状態を `RenderQueue` サービスが理解できる形式に変換し、描画コマンドを発行すること**です。このシステムはゲームロジックには一切関与せず、状態の「可視化」にのみ集中します。

---

## 関連コンポーレント

-   **`Renderable`**: このコンポーネントを持つエンティティは、すべて可視であると見なされます。
    -   `blockType`: ブロックの種類（例: `grass`, `dirt`）。使用されるマテリアルやテクスチャを決定します。
    -   `geometry`: 表示するメッシュの種類（現在はすべてのブロックで "box"）。
-   **`Position`**: エンティティの `(x, y, z)` 座標。Three.jsシーン内にオブジェクトを配置するために使用されます。

---

## システムのロジック (`sceneSystem`)

-   **ソース**: `src/systems/scene.ts`

何千ものブロックで構成される世界を描画するために要求される高いパフォーマンスを達成するため、このシステムは **Instanced Rendering（インスタンス化レンダリング）** を中心に構築されています。

### Instanced Rendering

個々のブロックごとに別々の `THREE.Mesh` を作成する（これは非常に非効率的で、何千ものドローコールにつながる）代わりに、このシステムは同じ `blockType` のすべてのブロックを単一の `THREE.InstancedMesh` にまとめます。

`InstancedMesh` を使うことで、GPUは同じジオメトリとマテリアルを持つ何千ものオブジェクトを、それぞれ異なる変換（位置、回転、スケール）で、単一のドローコールでレンダリングできます。これは、Web上で大規模なボクセルワールドのレンダリングを可能にするための鍵となる最適化です。

### 動作の仕組み

1.  **初期化とメッシュ管理**:
    -   `RendererThree` サービスは、`BlockType` ごとに一つずつ、`InstancedMesh` オブジェクトのレジストリ（`Map`）を維持します。
    -   新しい種類のブロックが初めてレンダリングされる必要がある場合、`MaterialManager` サービスから適切なマテリアルを要求し、そのための新しい `InstancedMesh` を作成します。このメッシュは、メインのThree.jsシーンに追加されます。

2.  **効率的なクエリと差分検出**:
    -   `sceneSystem` は毎フレーム、`world.querySoA` を使用して `Position` と `Renderable` コンポーネントを持つすべてのエンティティを取得します。
    -   現在のフレームのエンティティIDのセットと、前のフレームのIDのセットを比較し、どのエンティティが追加・更新・削除されたかの差分を検出します。

3.  **コマンドの送信**:
    -   検出された差分に基づき、`sceneSystem` は `UpsertEntity`（追加・更新用）または `RemoveEntity`（削除用）コマンドを生成します。
    -   これらのコマンドは、非同期の `RenderQueue` サービスに送信されます。

4.  **`RendererThree` によるシーンの更新**:
    -   `RendererThree` サービスは、バックグラウンドで `RenderQueue` をリッスンしています。
    -   キューからコマンドを受け取ると、`RendererThree` は対応する `InstancedMesh` の変換行列を更新（`setMatrixAt`）したり、インスタンスを非表示にしたりします。
    -   このアプローチにより、ゲームロジックの実行と実際のレンダリング処理が分離され、アプリケーション全体の応答性が向上します。

5.  **エンティティIDのマッピング**:
    -   `RendererThree` は、`[blockType, instanceId]` からECSの `EntityId` へのマッピングを `RenderContext` サービスに保存します。このマップは、後に `raycastSystem` がマウスカーソルの下にあるエンティティを迅速に特定するために使用されます。

このプロセスにより、Three.jsシーンがECSの状態を正確に視覚的に複製し、毎フレーム最大限の効率で更新されることが保証されます。