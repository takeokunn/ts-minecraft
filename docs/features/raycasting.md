# 機能仕様: レイキャスティング (Raycasting)

このドキュメントは、プレイヤーの視線の先にあるオブジェクトを特定する`raycastSystem`に関する仕様を定義します。

## 1. 責務

`raycastSystem`の責務は、**ワールドに対してクエリ（問い合わせ）を行い、その結果をデータとして記録すること**に特化しています。このシステムはワールドの状態を直接変更するのではなく、後続のシステム（`blockInteractionSystem`など）が利用するための「中間情報」を生成します。

主な責務は以下の通りです。

1.  プレイヤーのカメラの位置と向きからレイ（光線）を飛ばす。
2.  レイが衝突した最も手前のブロックを特定する。
3.  特定したブロックの情報を、プレイヤーエンティティに`Target`コンポーネントとしてアタッチ（または更新）する。
4.  ターゲットブロックの視覚的なハイライト表示を`Renderer`サービスに依頼する。

## 2. アルゴリズム

`raycastSystem`は毎フレーム、以下の処理を実行します。

1.  **プレイヤーの存在確認**: `world.querySingle(Player)` を実行し、プレイヤーエンティティが存在することを確認します。
2.  **レイの生成**: Three.jsの`Raycaster`を使用し、現在のカメラの位置から画面中央（視点）に向かってレイを生成します。
3.  **交差判定**:
    -   シーン内に存在するすべての描画オブジェクトとレイとの交差判定を行います。
    -   交差したオブジェクトの中から、以下の条件をすべて満たす、最もカメラに近いものをターゲットとして選択します。
        -   プレイヤーからの距離が`REACH`定数（現在: 8ブロック）以内である。
        -   水(water)やガラス(glass)のような、インタラクションの対象外と定義されたブロックではない。
4.  **ハイライト**: `Renderer`サービスの`updateHighlight`メソッドを呼び出し、見つかったターゲットオブジェクトを渡します。ターゲットが見つからなかった場合は`null`を渡し、ハイライトを非表示にします。
5.  **`Target`コンポーネントの更新**:
    -   まず、プレイヤーエンティティから既存の`Target`コンポーネントを削除します。これにより、毎フレーム情報がクリーンな状態に保たれます。
    -   新しいターゲットが見つかった場合、そのブロックの位置や、レイが当たった面の法線ベクトルなどの情報を`Target`コンポーネントとして作成し、プレイヤーエンティティに`addComponent`します。

## 3. データフロー

このシステムの重要な点は、**関心の分離**です。

-   `raycastSystem`は「知る」ことだけに責任を持ちます（＝どのブロックがターゲットか）。
-   `blockInteractionSystem`は、`Target`コンポーネントに記録された情報に基づいて「行動する」ことに責任を持ちます（＝ブロックを破壊・設置する）。

この設計により、例えば「見ているブロックの情報をUIに表示する」といった新しい機能を、既存のインタラクションロジックに影響を与えることなく、`Target`コンポーネントを読み取る新しい`uiSystem`を追加するだけで実装できます。
