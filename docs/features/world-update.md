# ワールド更新システム (World Update System)

ワールド更新システムは、プレイヤーが探検するゲーム世界の地形をプロシージャル（手続き的）に生成する責務を担います。ノイズアルゴリズムを利用して、再現可能でありながら無限に広がる、自然で変化に富んだ景観を創造します。

---

## 責務

`worldUpdateSystem` (`src/systems/world-update.ts`) の主な責務は、指定されたチャンク座標に対して、構成されるすべてのブロックエンティティを計算し、`World` に配置することです。このシステムは、ゲーム開始時やプレイヤーが新しいエリアに移動した際に `chunkLoadingSystem` によってトリガーされます。

---

## 関連コンポーネント

生成された地形は、以下のコンポーネントを持つブロックエンティティの集合体です。

-   **`Position`**: ワールド空間におけるブロックの整数座標 (`x`, `y`, `z`)。
-   **`Block`**: エンティティがブロックであることを示すコンポーネント。ブロックの種類 (`type`) を保持します（例: `GRASS`, `DIRT`, `STONE`）。
-   **`Collider`**: エンティティが物理的な当たり判定を持つことを示します。これにより、プレイヤーや他のエンティティが地形を通り抜けるのを防ぎます。

---

## 生成プロセス

ワールド生成はチャンク単位で行われます。各チャンクは `16x256x16` のブロックの集合です。

### 1. ノイズ生成器の初期化

-   **シード値**: ワールド生成は、単一のシード値（ランダムな文字列や数値）に基づいて行われます。
-   **擬似乱数生成器 (PRNG)**: このシード値から `alea` などのPRNGを初期化します。
-   **ノイズ関数**: PRNGを使って `simplex-noise` のインスタンスを生成します。

このアプローチにより、**同じシード値からは常に全く同じワールドが生成される**という再現性が保証されます。

### 2. 高さマップの計算

システムは、チャンク内の各 `(x, z)` 座標に対して、地面の高さを決定します。

-   **シンプレックスノイズ**: `noise2D(x, z)` 関数を呼び出して、`x` と `z` 座標に対応するノイズ値を取得します。シンプレックスノイズは、格子状のアーティファクトが少ない、滑らかで自然な値を生成します。
-   **フラクタルノイズ**: よりリアルな地形を生成するために、異なる周波数と振幅を持つ複数のノイズ関数を足し合わせる「フラクタルノイズ」の手法が用いられます。
    -   低周波数のノイズが大陸や山脈といった全体的な地形の起伏を決定します。
    -   高周波数のノイズが表面のざらつきや小さな丘などの細かいディテールを追加します。
-   **高さへのマッピング**: 最終的なノイズ値は、特定の範囲（例: `64` から `128`）にマッピングされ、その座標の `y` の高さとなります。

### 3. ブロックの配置

計算された高さマップに基づき、チャンク内の各 `(x, z)` 列にブロックを垂直に配置していきます。

1.  **エンティティの生成**: `y = 0` から計算された高さ `y_height` まで、ループ処理でブロックエンティティを `World` に生成します。
2.  **ブロックタイプの決定**: ブロックの `y` 座標に応じて、その種類を決定します。
    -   `y == y_height`: 表面は `GRASS` ブロック。
    -   `y_height - 3 < y < y_height`: 表面直下は `DIRT` ブロック。
    -   `y <= y_height - 3`: それより下はすべて `STONE` ブロック。
    -   `y < SEA_LEVEL`: 海水面より低い特定のブロックは `SAND` になる、などのルールも追加できます。

---

## 他のシステムとの連携

-   **`chunkLoadingSystem`**: プレイヤーの周囲を監視し、まだ生成されていない新しいチャンクの範囲に入った場合に `worldUpdateSystem` を呼び出します。これにより、無限に広がるワールドの幻想が生まれます。
-   **`sceneSystem`**: `worldUpdateSystem` によって `Block` コンポーネントを持つエンティティが `World` に追加されると、`sceneSystem` はそれを検知し、対応する3Dメッシュをレンダリングシーンに追加します。

この連携により、ワールドの生成と表示が効率的かつ動的に行われます。
