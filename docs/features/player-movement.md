# プレイヤー移動システム (Player Movement System)

- **関連ソース**: [`src/systems/player-movement.ts`](../../src/systems/player-movement.ts)
- **責務**: プレイヤーの入力状態とカメラの向きに基づいて移動とジャンプの意図を計算し、その結果を `Velocity` コンポーネントに反映すること。

---

## 概要

このシステムは、プレイヤーの「移動したい」という意図を物理的な「速度」に変換する役割を担います。入力状態とカメラの向きから進むべき方向と速さを決定し、`Velocity` コンポーネントを更新します。

このシステムは速度を計算するだけであり、**実際にエンティティの座標を移動させることはしません**。座標の更新は、この後に実行される `physicsSystem` と `collisionSystem` が担当します。この責務の分離が、予測可能でテストしやすい物理エンジンを構築する鍵となります。

## アーキテクチャ

`playerMovementSystem` は、`Effect<R, E, void>` として実装された `Effect` プログラムです。

- **依存性の注入**: `World` サービスを `Effect` のコンテキストを通じて受け取ります。
- **状態の更新**: `world.querySoA` を使ってコンポーネントの配列への直接参照を取得し、状態を効率的に更新します。
- **テスト容易性**: 速度計算などのコアロジックは、システム本体から独立した純粋な関数 (`calculateHorizontalVelocity`, `calculateVerticalVelocity` など) としてエクスポートされています。これにより、`Effect` ランタイムに依存しないユニットテストが容易になっています。

## 処理フロー

`playerMovementSystem` は毎フレーム実行され、以下の処理を行います。

1.  **クエリ実行**:
    - `playerMovementQuery` を使って、移動に必要なコンポーネント（`player`, `inputState`, `velocity`, `cameraState`）を持つエンティティのデータを `querySoA` で取得します。

2.  **垂直方向の速度計算**:
    - プレイヤーの `isGrounded` (接地フラグ) と `inputState.jump` (ジャンプ入力) を評価します。
    - 接地中にジャンプ入力があれば、垂直速度(`dy`)に `JUMP_FORCE` をセットし、`isGrounded` を `false` にして連続ジャンプを防ぎます。

3.  **水平方向の速度計算**:
    - 水平方向の入力（`forward`, `left`など）の有無で処理を分岐します。
    - **入力がある場合**:
      - `sprint` 入力に応じて移動速度を決定します。
      - 入力方向から移動ベクトルを計算し、斜め移動が速くなりすぎないよう正規化します。
      - カメラの `yaw`（左右の向き）を考慮し、移動ベクトルを回転させ、カメラが見ている方向に正しく移動するように調整します。
    - **入力がない場合**:
      - 現在の水平速度に減速率を乗算し、スムーズに減速させます。
      - 速度が閾値以下になったら完全に `0` にして停止させます。

4.  **コンポーネントの更新**:
    - 計算された新しい速度と接地状態を、`querySoA` で取得したコンポーネント配列に直接書き込み、更新を完了します。

## 実行順序

このシステムの実行順序は、物理シミュレーションの正確性を保証する上で極めて重要です。

`inputPollingSystem` -> `cameraControlSystem` -> **`playerMovementSystem`** -> `physicsSystem` -> `collisionSystem`

1.  `inputPollingSystem` と `cameraControlSystem` の**後**に実行されることで、常に最新の入力と視点情報に基づいて移動計算ができます。
2.  `physicsSystem` と `collisionSystem` の**前**に実行されることで、ここで計算された「移動の意図」としての速度が、その後の物理演算（重力適用）と衝突解決に正しく反映されます。
