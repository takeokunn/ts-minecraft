# チャンクロードシステム (Chunk Loading System)

-   **関連ソース**: [`src/systems/chunk-loading.ts`](../../src/systems/chunk-loading.ts)
-   **責務**: プレイヤーの位置を監視し、描画範囲に基づいてチャンクのロード（地形生成の依頼）とアンロード（エンティティの削除）を判断すること。

---

## 概要

チャンクロードシステムは、プレイヤーの位置に基づいてワールドの一部（チャンク）を動的にストリーミングする、パフォーマンス上極めて重要な機能です。これにより、メモリ使用量とアクティブなエンティティ数を管理可能な範囲に保ちつつ、無限に広がるワールドの幻想を生み出します。

このシステムは、プレイヤーがチャンク境界を越えたタイミングを検知し、どのチャンクを新たにロードし、どのチャンクをアンロードすべきかを計算します。そして、ロードが必要なチャンクについては `GenerateChunk` コマンドを発行し、アンロードが必要なチャンクは `World` から削除します。

## アーキテクチャ

`chunkLoadingSystem`は、`(world: World, deps: SystemDependencies) => [World, SystemCommand[]]` というシグネチャを持つ純粋な関数 (`System`) として実装されています。システムの主な役割は、`GenerateChunk` コマンドを発行することです。このコマンドはランタイム (`loop.ts`) によって捕捉され、`main.ts` で定義されたハンドラによって `computation.worker.ts` への地形生成タスク依頼に変換されます。

## `globalState` による状態管理

このシステムは、コンポーネントではなく `world.globalState.chunkLoading` というグローバルな状態オブジェクトを使って、チャンクのロード状態を一元管理します。

-   **`world.globalState.chunkLoading`**:
    -   **`lastPlayerChunk`**: プレイヤーが最後にいたチャンクの座標 (`{x, z}`)。毎フレームの冗長な計算を避け、プレイヤーがチャンク境界を越えた時のみに処理を実行するために使用されます。
    -   **`loadedChunks`**: 現在ロードされているチャンクのマップ (`Map<string, EntityId>`)。キーは `"x,z"` 形式のチャンク座標、値は対応するチャンクエンティティのIDです。

## 処理フロー

`chunkLoadingSystem` は毎フレーム実行されますが、実質的な処理はプレイヤーがチャンクを移動した時のみ実行されます。

1.  **チャンク移動検知**:
    -   プレイヤーの現在の `Position` から、現在いるチャンクの座標を計算します。
    -   `globalState.lastPlayerChunk` に保存されている前回の座標と比較し、プレイヤーが新しいチャンクに移動していない場合は、何もせず処理を終了します。

2.  **ロード/アンロード対象の計算 (`calculateChunkUpdates`)**:
    -   プレイヤーがチャンクを移動した場合、この純粋関数が呼び出されます。
    -   **必要チャンクの特定**: プレイヤーの現在チャンク座標と `RENDER_DISTANCE` から、現在ロードされているべきすべてのチャンク座標のセット (`requiredChunks`) を計算します。
    -   **比較と差分検出**: `requiredChunks` と `globalState.loadedChunks` を比較し、以下の2つのリストを生成します。
        -   `toLoad`: `requiredChunks` には存在するが、`loadedChunks` には存在しない、新たにロードすべきチャンクの座標リスト。
        -   `toUnload`: `loadedChunks` には存在するが、`requiredChunks` には存在しない、アンロードすべきチャンクエンティティのIDリスト。

3.  **コマンド発行とWorld更新**:
    -   **ロード処理**: `toLoad` リストの各座標に対して、`{ _tag: 'GenerateChunk', ... }` という `SystemCommand` を生成します。これらのコマンドが、このシステムの返り値となります。
    -   **アンロード処理**: `toUnload` リストの各エンティティIDに対して `removeEntity` ヘルパーを呼び出し、`World` からチャンクエンティティを削除します。
    -   **状態更新**: `globalState.lastPlayerChunk` をプレイヤーの現在のチャンク座標で更新し、次のフレームでの検知に備えます。

この継続的なプロセスにより、プレイヤーがワールドを移動するにつれて、周囲の地形がシームレスにストリーミングされる体験が実現されます。
