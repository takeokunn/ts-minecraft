# チャンクロードシステム (Chunk Loading System)

チャンクロードシステムは、プレイヤーの位置に基づいてワールドの一部（チャンク）を動的にロード・アンロードする、パフォーマンス上極めて重要な機能です。これにより、メモリ使用量とアクティブなエンティティ数を管理可能な範囲に保ちつつ、無限に広がるワールドの幻想を生み出します。

-   **関連ソース**: [`src/systems/chunk-loading.ts`](../../src/systems/chunk-loading.ts)

---

## 責務

`chunkLoadingSystem` の責務は、毎フレームプレイヤーの位置を監視し、以下の2つのタスクを実行することです。

1.  **チャンクのアンロード**: プレイヤーの描画範囲（`RENDER_DISTANCE`）から外れたチャンクと、それに含まれるすべての地形ブロックを `World` から削除します。
2.  **チャンクのロード**: プレイヤーが新しく入った描画範囲内の未ロードチャンクに対して、地形生成タスクを `Computation` サービス（Web Worker）に依頼します。

---

## 主要なコンポーネントと概念

-   **`Chunk`**: ロード済みのチャンクを示すマーカーエンティティが持つコンポーネント。チャンクのグリッド座標 `x`, `z` を保持します。
-   **`ChunkLoaderState`**: シングルトンエンティティが持つコンポーネント。プレイヤーが最後にいたチャンクの座標 `currentPlayerChunkX`, `currentPlayerChunkZ` を保持し、プレイヤーがチャンクを移動したかどうかを効率的に検知するために使われます。
-   **`Position`**: プレイヤーの現在位置を特定するために使用します。
-   **`TerrainBlock`**: アンロード時に削除対象となる、地形を構成するブロックエンティティを識別するためのタグ。

---

## システムのロジック (`chunkLoadingSystem`)

`chunkLoadingSystem` は `Effect` プログラムとして実装されており、以下のステップで実行されます。

1.  **プレイヤーとローダーの取得**: `world.querySoA` を使ってプレイヤーと、`ChunkLoaderState` を持つシングルトンエンティティを取得します。
2.  **チャンク移動検知**:
    -   プレイヤーの現在の `Position` から、現在いるチャンクの座標 (`playerChunkX`, `playerChunkZ`) を計算します。
    -   `ChunkLoaderState` に保存されている前回の座標と比較し、プレイヤーが新しいチャンクに移動していない場合は、何もせず処理を終了します。これにより、不要な計算を毎フレーム行うことを防ぎます。
    -   移動していた場合は、`ChunkLoaderState` を新しい座標で更新します。
3.  **必要チャンクとロード済みチャンクの特定**:
    -   **必要チャンク**: プレイヤーの現在チャンク座標と `RENDER_DISTANCE` から、現在ロードされているべきすべてのチャンク座標のセット (`requiredChunks`) を計算します。
    -   **ロード済みチャンク**: `World` 内のすべての `Chunk` コンポーネントをクエリし、現在ロード済みのチャンク座標のマップ (`loadedChunks`) を作成します。
4.  **アンロード処理**:
    -   `loadedChunks` に存在し、`requiredChunks` には存在しないチャンクを特定します。
    -   対象チャンクごとに、そのチャンク範囲内に含まれるすべての `TerrainBlock` タグを持つエンティティを `World` から削除します。
    -   最後に、`Chunk` マーカーエンティティ自体も削除します。
5.  **ロード処理**:
    -   `requiredChunks` に存在し、`loadedChunks` には存在しないチャンクを特定します。
    -   対象チャンクごとに、`Computation` サービスの `generateChunk` メソッドを `Effect.fork` を使って呼び出します。`fork` を使うことで、重い地形生成タスクをワーカースレッドに依頼しつつ、メインスレッドの処理をブロックすることなく次のフレームに進むことができます。
    -   同時に、新しい `Chunk` マーカーエンティティを `World` に即座に追加し、同じチャンクのロード処理が重複して開始されるのを防ぎます。

この継続的なプロセスにより、プレイヤーがワールドを移動するにつれて、周囲の地形がシームレスにストリーミングされる体験が実現されます。