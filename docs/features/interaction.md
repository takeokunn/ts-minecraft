# 機能仕様: インタラクション (Interaction)

このドキュメントは、プレイヤーがワールドに対して行う操作、特にブロックの設置と破壊に関する仕様を定義します。このロジックは `interactionSystem` が担当します。

## 1. 責務

`interactionSystem` は、プレイヤーの視線の先にあるオブジェクトを特定し、クリック入力に応じてブロックを破壊または設置する責務を持ちます。また、破壊・設置されたブロックの情報を `GameState` サービスに記録し、セーブデータやチャンクの再生成に利用できるようにします。

## 2. ターゲットブロックの特定: レイキャスティング

プレイヤーがどのブロックを見ているかは、毎フレーム実行されるレイキャスティングによって決定されます。

-   **アルゴリズム**:
    1.  Three.jsの `Raycaster` を使用し、カメラの位置から画面中央（視点）に向かってレイを飛ばします。
    2.  シーン内のすべてのオブジェクトとの交差判定を行います。
    3.  交差したオブジェクトの中から、以下の条件を満たす最も手前のものをターゲットとして選択します。
        -   プレイヤーからの距離が `REACH` 定数（現在: 8ブロック）以内であること。
        -   水(water)やガラス(glass)のような、インタラクションの対象外となる透明なブロックではないこと。
-   **ハイライト**:
    -   特定されたターゲットブロックは、`Renderer` サービスを通じてハイライト表示されます。これにより、プレイヤーはどのブロックを操作しようとしているかを視覚的に確認できます。
    -   ターゲットがない場合、ハイライトは非表示になります。

## 3. ブロックの破壊 (左クリック)

-   **トリガー**: `Input` サービスから左クリックイベントを検知する。
-   **プロセス**:
    1.  レイキャスティングでターゲットブロックが特定されていることを確認します。
    2.  ターゲットオブジェクトの `instanceId`（Three.jsの`InstancedMesh`内でのID）を取得します。
    3.  `RenderContext` サービスが保持する `instanceId` と `EntityId` のマッピングを使い、対応するエンティティIDを高速に検索します。
    4.  エンティティIDが見つかった場合、そのエンティティの `Position` コンポーネントを取得します。
    5.  `GameState` サービスの `addDestroyedBlock` メソッドを呼び出し、破壊されたブロックの座標を記録します。
    6.  `World` サービスの `deleteEntity` を呼び出し、ワールドからそのブロックエンティティを完全に削除します。

## 4. ブロックの設置 (右クリック or 'Q'キー)

-   **トリガー**: `Input` サービスから右クリックイベント、または `InputState` コンポーネントから `place` フラグを検知する。
-   **プロセス**:
    1.  レイキャスティングでターゲットブロックが特定されており、かつレイが当たった面の情報 (`target.face`) が取得できていることを確認します。
    2.  **設置座標の計算**:
        -   レイが当たった正確な座標 (`target.point`) と、その面の法線ベクトル (`target.face.normal`) を使用します。
        -   ターゲットブロックの面に隣接する位置に、新しいブロックの座標を計算します。
    3.  **プレイヤーとの衝突判定**:
        -   計算された設置座標にブロックを置いた場合、プレイヤーのAABBと衝突しないかを確認します。
        -   衝突する場合、プレイヤーがブロックに埋まってしまうのを防ぐため、設置処理をキャンセルします。
    4.  **ブロックタイプの決定**: `GameState` サービスから、現在ホットバーで選択されているブロックのタイプを取得します。
    5.  **エンティティの生成**: `World` サービスの `createEntity` を呼び出し、計算した座標に選択中のブロックタイプの新しいエンティティを生成します。
    6.  `GameState` サービスの `addPlacedBlock` メソッドを呼び出し、設置されたブロックの座標と種類を記録します。

## 5. 依存関係

-   **`Input`**: マウスのクリック状態を取得します。
-   **`ThreeJsContext`**: `Raycaster` の起点となるカメラと、交差判定の対象となるシーンオブジェクトにアクセスします。
-   **`World`**: エンティティの削除と生成を行います。
-   **`GameState`**: 破壊/設置されたブロックの情報を記録し、ホットバーの選択状態を取得します。
-   **`RenderContext`**: `instanceId` から `EntityId` へのマッピングを提供します。
-   **`Renderer`**: ターゲットブロックのハイライト表示を依頼します。