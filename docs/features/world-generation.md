# ワールド生成 (World Generation)

ワールド生成は、プレイヤーが探検するゲーム世界の地形をプロシージャル（手続き的）に生成するプロセスです。Simplex Noise（ソースコードでは`perlin-noise`ライブラリを使用）を利用して、再現可能でありながら無限に広がる、自然で変化に富んだ景観を創造します。

この処理は計算負荷が非常に高いため、メインスレッドをブロックしないようWeb Worker (`src/workers/computation.worker.ts`) 内で完全に非同期に実行されます。

---

## 責務

`computation.worker.ts` は、メインスレッドからチャンク座標とワールド生成パラメータを受け取り、以下の2つの主要な成果物を計算して返す責務を担います。

1.  **ブロックデータ (`BlockData[]`)**: そのチャンクを構成するすべてのブロックの種類と位置のリスト。
2.  **メッシュデータ (`Mesh`)**: レンダリングのために最適化された、チャンクの可視ジオメトリ（頂点、法線、UV、インデックス）。

---

## 生成プロセス

ワールド生成は、`generateChunk` 関数内で以下の2つの主要なステップを経て行われます。

### ステップ1: ブロックデータの生成

このステップでは、チャンク内のどの座標にどの種類のブロックが存在するかが決定されます。

1.  **ノイズ生成器の初期化**:
    -   メインスレッドから受け取った複数のシード値（`world`, `biome`, `trees`）に基づき、`noise.seed()` を呼び出してノイズ関数を初期化します。これにより、**同じシード値からは常に全く同じワールドが生成される**という再現性が保証されます。

2.  **高さマップとバイオームの計算**:
    -   チャンク内の各 `(x, z)` 座標に対して、`noise.perlin2(x, z)` を複数回呼び出し、地形の高さ、バイオーム（平原か砂漠かなど）、木の配置を決定します。異なるシードを使うことで、これらの要素は互いに独立しつつも、同じ座標に対しては常に同じ値が生成されます。

3.  **ブロックの配置**:
    -   計算された高さとバイオームに基づき、各 `(x, z)` 列にブロックを垂直に配置していきます。
    -   **基本地形**: 地表からの深さに応じて、`grass` (草)、`dirt` (土)、`stone` (石) などを配置します。バイオームが `desert` (砂漠) であれば `sand` (砂) になります。
    -   **水の配置**: 計算された高さが `WATER_LEVEL` より低い場合、そのレベルまで `water` (水) ブロックを配置します。
    -   **木の配置**: 木のシードから生成したノイズが特定の値になった地点に、`oakLog` (オークの原木) と `oakLeaves` (オークの葉) からなる木を生成します。

4.  **プレイヤーによる変更の適用**:
    -   地形の基本生成が終わった後、メインスreadから受け取った `editedBlocks`（プレイヤーによって破壊・設置されたブロック）の情報を反映させます。破壊されたブロックは生成データから削除され、設置されたブロックが追加されます。

### ステップ2: メッシュデータの生成 (Greedy Meshing)

生成された何万ものブロックデータをそのままレンダリングすると、パフォーマンスが著しく低下します。そこで、**Greedy Meshing** アルゴリズムを用いて、描画に必要なジオメトリを劇的に削減します。

1.  **チャンクデータの3D配列化**: まず、ステップ1で生成されたブロックのリストを、扱いやすい3次元配列 `(BlockType | undefined)[][][]` に変換します。
2.  **面の抽出**: 3つの軸（X, Y, Z）それぞれに対して、チャンクの内部を走査します。隣接するブロックの種類が異なり、片方が不透明で片方が透明（空気など）である場合、その境界に「面」が存在すると判断します。
3.  **面の統合 (Greedy part)**:
    -   抽出した面を起点に、同じ種類・同じ向きの面が隣接している限り、それを貪欲に（Greedy）マージしていき、可能な限り大きな長方形のメッシュを形成します。
    -   例えば、10x10の平らな草の地面は、100個の小さな上面メッシュではなく、たった1つの大きな上面メッシュとして生成されます。
4.  **頂点データの生成**:
    -   統合された大きなメッシュごとに、4つの頂点（`positions`）、法線（`normals`）、UV座標（`uvs`）、および2つの三角形を定義するインデックス（`indices`）を生成します。
    -   UV座標は、テクスチャアトラス上の正しいテクスチャをマッピングするように計算されます。

この最適化により、チャンクの内部で完全に見えなくなっている面がすべて削除され、頂点数と描画呼び出し（ドローコール）の回数が90%以上削減されます。

---

## 他のシステムとの連携

-   **`chunkLoadingSystem`**: プレイヤーの周囲を監視し、まだ生成されていない新しいチャンクの範囲に入った場合に、このWorkerに地形生成タスクを依頼します。
-   **`worldUpdateSystem`**: Workerが生成したブロックデータとメッシュデータを受け取り、ゲームワールドの状態を更新し、レンダリングのためのコマンドを発行します。