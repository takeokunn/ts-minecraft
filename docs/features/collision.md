# 衝突検知・解決システム (Collision System)

衝突検知・解決システムは、エンティティがワールド内の地形（ブロック）を通り抜けることなく、物理的に正しく相互作用することを保証する重要な機能です。`physicsSystem` によって計算された移動を検証し、衝突が発生した場合にはエンティティの位置を補正する責務を担います。

---

## 責務

`collisionSystem` (`src/systems/collision.ts`) の唯一の責務は、**エンティティの位置を検証し、衝突を解決すること**です。このシステムはエンティティを能動的に移動させるのではなく、`physicsSystem` によってすでに行われた移動の「結果」を補正します。

---

## 関連コンポーネント

衝突検知と解決のプロセスは、以下のコンポーネントを持つエンティティに作用します。

-   **`Position`**: `physicsSystem` によって更新された、エンティティの「暫定的な」現在位置。このシステムは、この位置が不正（ブロックにめり込んでいる）であれば、それを補正します。
-   **`Collider`**: エンティティの物理的な境界を示す軸並行境界ボックス（AABB）を定義します (`width`, `height`, `depth`)。ブロックとの交差判定に不可欠です。
-   **`Player`**: プレイヤーエンティティを識別するためのタグ。衝突の結果、特に地面との接触を検知した場合に、このコンポーネントの `isGrounded` フラグが更新されます。
-   **`Velocity`**: 衝突解決の際に、エンティティがどの方向に移動していたかを知るために読み取られます。衝突が発生した場合、対応する軸の速度は0にリセットされます。

---

## システムのロジック (`collisionSystem`)

システムは、`querySoA` と `PhysicsWorld` サービスを活用して、以下のステップで効率的に衝突解決を実行します。

1.  **プレイヤーデータの取得**: `querySoA` を使用して、`Position`, `Velocity`, `Collider`, `Player` を持つエンティティ（プレイヤー）のSoAデータを取得します。
2.  **広域衝突検知 (Broad-Phase)**:
    -   `PhysicsWorld` サービス（空間グリッド）にプレイヤーの周囲のAABBを問い合わせ、衝突の可能性がある近隣エンティティのIDリストを効率的に取得します。これにより、ワールド内のすべてのブロックをチェックする無駄を省きます。
3.  **近隣エンティティのデータ取得**:
    -   広域検知で得られたエンティティIDのリストを使い、再度 `querySoA` を呼び出します。これにより、衝突候補となるエンティティの `Position` と `Collider` のデータを、極めて効率的に一括で取得します。
4.  **狭域衝突解決 (Narrow-Phase)**:
    -   衝突解決は、**Y軸（垂直方向）**、**X軸（水平方向）**、**Z軸（水平方向）**の順で、軸ごとに独立して行われます。この軸分離（Axis Separation）が、壁に沿ってスムーズに滑るような自然な挙動を実現するために重要です。
    -   各軸で、プレイヤーのAABB（軸並行境界ボックス）と近隣ブロックのAABBとの間で交差をチェックします。
    -   交差が検出された場合、プレイヤーの `Position` をブロックの表面にぴったりと接するように補正し、対応する `Velocity` 成分を `0` にリセットします。
    -   エンティティが下向きに移動中にY軸の衝突が発生した場合、`Player` コンポーネントの `isGrounded` フラグを `true` に設定します。
5.  **コンポーネントの更新**: すべての軸で衝突解決が完了した後、最終的に補正された `Position`、`Velocity`、`Player` コンポーネントを `world.updateComponentData` を使って `World` に書き戻します。このAPIは不要なオブジェクト生成を避けるため、パフォーマンスを高く維持します。

---

## 他のシステムとの連携

`collisionSystem` は、システムの実行順序において、物理演算と空間グリッドの更新の**直後**に実行される必要があります。

`playerMovementSystem` -> `physicsSystem` -> `updatePhysicsWorldSystem` -> **`collisionSystem`**

1.  **`playerMovementSystem`**: 移動の「意図」を `Velocity` に設定します。
2.  **`physicsSystem`**: `Velocity` に重力を適用し、`Position` を暫定的に更新します。
3.  **`updatePhysicsWorldSystem`**: 更新された `Position` に基づいて `PhysicsWorld` の空間グリッドを最新の状態にします。
4.  **`collisionSystem` (このシステム)**: 最新の空間グリッドを使って効率的に衝突検知を行い、`Position` を最終的な正しい位置に「確定」させます。

このパイプラインにより、各システムが単一の責務に集中でき、複雑な物理的インタラクションをクリーンで予測可能な方法で実現しています。