# 衝突検知システム (Collision System)

衝突検知システムは、エンティティがワールド内の地形（ブロック）を通り抜けることなく、物理的に正しく相互作用することを保証する重要な機能です。`physicsSystem` によって計算された移動を検証し、衝突が発生した場合にはエンティティの位置を補正する責務を担います。

---

## 責務

`collisionSystem` (`src/systems/collision.ts`) の唯一の責務は、**エンティティの位置を検証し、衝突を解決すること**です。このシステムはエンティティを移動させるのではなく、`physicsSystem` によってすでに行われた移動結果を補正します。

---

## 関連コンポーネント

衝突検知と解決のプロセスは、以下のコンポーネントを持つエンティティに作用します。

-   **`Position`**: `physicsSystem` によって更新された、エンティティの「暫定的な」現在位置。このシステムは、この位置が不正（ブロックにめり込んでいる）であれば、それを補正します。
-   **`Collider`**: エンティティの物理的な境界を示す軸並行境界ボックス（AABB）を定義します (`width`, `height`, `depth`)。ブロックとの交差判定に不可欠です。
-   **`Player`**: プレイヤーエンティティを識別するためのタグ。衝突の結果、特に地面との接触を検知した場合に、このコンポーネントの `isGrounded` フラグが更新されます。
-   **`Velocity`**: 衝突解決の際に、エンティティがどの方向に移動していたかを知るために読み取られます（特にY軸方向の衝突判定）。

---

## システムのロジック (`collisionSystem`)

システムは、`querySoA` を活用してプレイヤーと地形ブロックのデータを効率的に取得し、以下のステップで衝突解決を実行します。

1.  **クエリ**:
    -   `querySoA` を使用して、`Position`, `Velocity`, `Collider`, `Player` を持つエンティティ（プレイヤー）のSoAデータを取得します。
    -   同様に、`Position` と `TerrainBlock` を持つすべての地形ブロックのSoAデータを取得します。
2.  **広域衝突検知 (Broad-Phase)**:
    -   プレイヤーの周囲の一定範囲内（現在は4x4x4ブロック）にあるブロックのみを衝突候補として絞り込みます。これにより、ワールド内のすべてのブロックをチェックする無駄を省きます。
    -   この処理は、地形ブロックのSoAデータを `for` ループで走査して行われます。
3.  **狭域衝突解決 (Narrow-Phase)**:
    -   衝突解決は、**Y軸（垂直方向）**、**X軸（水平方向）**、**Z軸（水平方向）**の順で、軸ごとに独立して行われます。この軸分離（Axis Separation）が、壁に沿ってスムーズに滑るような自然な挙動を実現するために重要です。
    -   **Y軸の解決**:
        -   まず、`Velocity.dy` をプレイヤーの `Position.y` に適用します。
        -   その後、プレイヤーのAABB（軸並行境界ボックス）と近隣ブロックのAABBとの間で交差をチェックします。
        -   交差が検出された場合、プレイヤーの `Position.y` をブロックの表面にぴったりと接するように補正し、`Velocity.dy` を `0` にリセットします。
        -   エンティティが下向きに移動中にこの衝突が発生した場合、`Player` コンポーネントの `isGrounded` フラグを `true` に設定します。
    -   **X軸・Z軸の解決**:
        -   Y軸解決後の位置を元に、X軸とZ軸で同様の移動適用、交差チェック、位置補正を行います。
        -   壁との衝突が検出された場合、`Position` を壁の表面に補正し、対応する `Velocity` 成分（`dx` または `dz`）を `0` にリセットします。
4.  **コンポーネントの更新**: すべての軸で衝突解決が完了した後、最終的に補正された `Position`、`Velocity`、`Player` コンポーネントを `World` に書き戻します。

---

## 他のシステムとの連携

`collisionSystem` は、システムの実行順序において `physicsSystem` の**直後**に実行される必要があります。

`playerMovementSystem` -> `physicsSystem` -> **`collisionSystem`**

1.  **`playerMovementSystem`**: 移動の「意図」を `Velocity` に設定します。
2.  **`physicsSystem`**: `Velocity` に重力を適用し、Y軸の速度を更新します。
3.  **`collisionSystem` (このシステム)**: `physicsSystem` の結果を含む `Velocity` を使って、各軸で移動と衝突解決を行い、`Position` を最終的な正しい位置に「確定」させます。

このパイプラインにより、各システムが単一の責務に集中でき、複雑な物理的インタラクションをクリーンで予測可能な方法で実現しています。