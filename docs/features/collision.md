# 機能仕様: 衝突検知 (Collision)

このドキュメントは、エンティティ（特にプレイヤー）とワールド内の地形ブロックとの衝突検知および解決に関する仕様を定義します。このロジックは `collisionSystem` が担当します。

## 1. 責務と役割

`collisionSystem` は、`physicsSystem` の後に実行され、エンティティがワールドジオメトリを貫通しないようにする最終的な砦です。主な責務は以下の通りです。

1.  エンティティの現在の `Velocity` を `Position` に適用する。
2.  移動中に地形ブロックと衝突しないか検知する。
3.  衝突が発生する場合、エンティティの `Position` を適切に補正し、`Velocity` をリセットする。
4.  プレイヤーの接地状態 (`isGrounded`) を更新する。

現在の実装は、プレイヤーと地形ブロック間の衝突のみを扱います。

## 2. アルゴリズム: AABB (Axis-Aligned Bounding Box)

-   **衝突形状**: すべてのエンティティとブロックは、軸に平行な直方体である「AABB」として扱われます。
    -   プレイヤーのAABBは `Collider` コンポーネントで定義されます（幅、高さ、奥行き）。
    -   ブロックのAABBは、一辺が1の立方体としてハードコードされています。
-   **交差判定**: `aabbIntersect` 関数が、2つのAABBが空間内で重なっているかどうかを判定します。

## 3. 衝突解決プロセス

衝突解決は、計算の単純化と精度の向上のため、**軸ごと（Y, X, Zの順）に分離して**行われます。これにより、「壁に滑る」ような挙動が自然に実現されます。

1.  **ブロードフェーズ (Broad Phase)**:
    -   パフォーマンスを最適化するため、ワールド内のすべてのブロックと衝突判定を行うことは避けます。
    -   最初に、プレイヤーの周囲の一定範囲内（現在は半径4ブロック）にあるブロックのみを抽出し、これらを「衝突候補」とします。

2.  **Y軸の解決**:
    -   まず、Y軸方向の速度 (`newVel.dy`) のみをプレイヤーの現在位置に加算し、仮の未来位置を計算します。
    -   衝突候補のブロックとAABB交差判定を行います。
    -   **衝突した場合**:
        -   エンティティが下方向に移動中（`newVel.dy < 0`）であれば、エンティティの位置をブロックの上面に接するように補正し、`isGrounded` フラグを `true` に設定します。
        -   エンティティが上方向に移動中（`newVel.dy > 0`）であれば、エンティティの位置をブロックの下面に接するように補正します（頭をぶつけた場合）。
        -   Y軸方向の速度 `newVel.dy` を `0` にリセットし、それ以上その方向に進まないようにします。

3.  **X軸の解決**:
    -   次に、X軸方向の速度 (`newVel.dx`) を（Y軸解決後の）位置に加算します。
    -   衝突候補のブロックと再度AABB交差判定を行います。
    -   **衝突した場合**:
        -   エンティティの位置を、衝突したブロックの側面に接するように補正します。
        -   X軸方向の速度 `newVel.dx` を `0` にリセットします。

4.  **Z軸の解決**:
    -   最後に、Z軸方向の速度 (`newVel.dz`) を（X軸解決後の）位置に加算します。
    -   衝突候補のブロックとAABB交差判定を行います。
    -   **衝突した場合**:
        -   エンティティの位置を、衝突したブロックの側面に接するように補正します。
        -   Z軸方向の速度 `newVel.dz` を `0` にリセットします。

5.  **状態の更新**:
    -   すべての軸の解決が完了した後、最終的に補正された位置 (`newPos`)、速度 (`newVel`)、および接地状態 (`isGrounded`) をプレイヤーエンティティのコンポーネントに書き込みます。

## 4. `isGrounded` フラグ

-   このフラグは、プレイヤーが地面に立っているかどうかを示します。
-   Y軸の衝突解決中に、プレイヤーの下方への移動がブロックによって妨げられた場合に `true` に設定されます。
-   `playerSystem` はこのフラグを参照し、プレイヤーがジャンプ可能かどうかを判断します。