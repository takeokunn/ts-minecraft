# 機能仕様: World サービス

このドキュメントは、ECS（Entity Component System）アーキテクチャの中核をなす `World` サービスについて詳述します。`World` サービスは、ゲーム内に存在するすべてのエンティティとコンポーネントの状態を一元管理する、唯一の信頼できる情報源（Source of Truth）です。

## 1. 責務と実装

-   **責務**:
    -   すべてのエンティティとそのコンポーネントの集合を状態として保持する。
    -   状態の読み取り（クエリ）と変更（作成、更新、削除）のための、安全で型安全なAPIを提供する。
-   **実装**:
    -   `World` サービスの実体は、Effectの `Ref<WorldState>` です。`Ref` はアトミックな更新が可能な可変参照であり、複数のシステムから同時にアクセスされても状態の整合性を保ちます。
    -   `WorldState` は `Map<EntityId, Set<Component>>` というデータ構造を持ち、各エンティティIDに、そのエンティティが持つコンポーネントのセットを関連付けます。

## 2. 主要API

`World` サービスと対話するための操作は、`src/runtime/world.ts` 内でEffectとして定義されています。

### `createEntity(...components)`

-   **目的**: 新しいエンティティをワールドに追加します。
-   **引数**: 任意の数のコンポーネント。
-   **処理**:
    1.  一意な `EntityId` を生成します。
    2.  引数で渡されたコンポーネントを `Set` に格納します。
    3.  ワールドの状態（`Map`）に新しい `EntityId` とコンポーネントのセットを追加します。
-   **戻り値**: 生成されたエンティティの `EntityId`。

### `deleteEntity(id)`

-   **目的**: 指定されたエンティティをワールドから削除します。
-   **引数**: 削除するエンティティの `EntityId`。
-   **処理**: ワールドの状態から、指定された `EntityId` のエントリを削除します。

### `updateComponent(id, component)`

-   **目的**: エンティティのコンポーネントを更新または追加します。
-   **引数**:
    -   `id`: 対象エンティティの `EntityId`。
    -   `component`: 更新または追加するコンポーネント。
-   **処理**:
    1.  エンティティのコンポーネントセットを取得します。
    2.  更新するコンポーネントと同じ `_tag` を持つ既存のコンポーネントをセットから削除します。
    3.  新しいコンポーネントをセットに追加します。
    -   これにより、各エンティティは同じ種類のコンポーネントを1つしか持てないことが保証されます。

### `query(...schemas)`

-   **目的**: 指定されたすべてのコンポーネントを持つエンティティを検索します。
-   **引数**: 任意の数の `@effect/schema` のスキーマ。
-   **処理**:
    1.  ワールド内のすべてのエンティティを走査します。
    2.  各エンティティが、引数で指定されたすべてのスキーマに対応するコンポーネント（`_tag` で判定）を持っているかを確認します。
    3.  条件を満たすエンティティをリストとして返します。
-   **戻り値**: `QueryResult` の配列。`QueryResult` は、エンティティの `id` と、スキーマを渡して型安全にコンポーネントを取得できる `get` メソッドを持つ便利なオブジェクトです。

### `getComponent(id, schema)`

-   **目的**: 特定のエンティティから単一のコンポーネントを安全に取得します。
-   **引数**:
    -   `id`: 対象エンティティの `EntityId`。
    -   `schema`: 取得したいコンポーネントのスキーマ。
-   **戻り値**: 見つかったコンポーネント、または `undefined`。