# 機能仕様: プレイヤー制御 (Player Control)

このドキュメントは、プレイヤーの入力がどのように処理され、ゲームワールド内でのアクションに変換されるかを担当する `playerControlSystem` について詳述します。

## 1. 責務

`playerControlSystem` の主な責務は、プレイヤーからの入力（キーボードとマウス）を解釈し、プレイヤーエンティティの **意図** を表現するコンポーネント（主に `Velocity`）を更新することです。このシステムは、物理演算や衝突検知を直接行わず、それらの計算の **入力** となる値を設定する役割を担います。

## 2. 処理フロー

`playerControlSystem` は、毎フレーム以下の処理を実行します。

1.  **クエリ**: `Player`, `InputState`, `Velocity`, `CameraState` コンポーネントを持つエンティティ（＝プレイヤー）を `World` から検索します。
2.  **入力の取得**: `Input` サービスから、現在のフレームでのマウスの移動量 (`dx`, `dy`) を取得します。キーボード入力は `InputState` コンポーネントから直接読み取られます。
3.  **カメラ制御**: マウスの移動量に基づき、カメラの向きを更新します。
4.  **移動計算**: キーボードの入力状態 (`W`, `A`, `S`, `D`, `Space`) に基づき、プレイヤーがどの方向にどれだけの力で移動しようとしているかを計算します。
5.  **コンポーネント更新**: 計算結果をプレイヤーエンティティの `Velocity` および `Player` コンポーネントに書き込みます。

---

## 3. 詳細なロジック

### カメラ制御 (Rotation)

-   **実装**: カメラの制御は、ECSの原則から少し逸脱し、Three.jsの `PointerLockControls` を直接操作することで実現されています。これは、`PointerLockControls` が自身の内部状態でカメラの回転を管理するため、最も直接的で効率的な方法だからです。
-   **Yaw (水平回転)**: マウスの水平移動 (`mouseState.dx`) に応じて、`PointerLockControls` オブジェクト全体のY軸回転を更新します。
-   **Pitch (垂直回転)**: マウスの垂直移動 (`mouseState.dy`) に応じて、コントロールオブジェクトの子要素であるカメラ自体のX軸回転を更新します。
-   **Pitchの制限**: 垂直方向の回転は、真上 (`-PI/2`) から真下 (`PI/2`) の範囲にクランプ（制限）され、プレイヤーが逆さまになるのを防ぎます。
-   **状態の同期**: `PointerLockControls` を直接操作した後、その結果（現在のpitchとyaw）をプレイヤーエンティティの `CameraState` コンポーネントに書き戻します。これにより、ゲームの状態をセーブする際や、他のシステムがプレイヤーの向きを知る必要がある場合に、ECSの枠組みから正確な情報を取得できます。

### 移動 (Movement)

-   **基本速度**: `PLAYER_SPEED` 定数で定義されます。
-   **スプリント**: `InputState` の `sprint` フラグが `true` の場合、移動速度は `SPRINT_MULTIPLIER` (1.6倍) によって増加します。
-   **方向計算**:
    -   `W`, `A`, `S`, `D` の入力は、現在のカメラの `yaw`（水平方向の向き）を基準に、どの方向への移動ベクトル（`dx`, `dz`）を生成するかを決定します。
    -   例えば、`W` を押すと、カメラが向いている方向（`-sin(yaw)`, `-cos(yaw)`）に速度が加算されます。
-   **慣性 (Deceleration)**:
    -   プレイヤーが移動キーを離すと、速度は即座に0になるのではなく、`DECELERATION` (0.85) の係数が毎フレーム乗算され、滑らかに減速します。
    -   速度が非常に小さい値 (`MIN_VELOCITY`) になると、完全に0にリセットされます。

### ジャンプ (Jumping)

-   **条件**: `InputState` の `jump` フラグが `true` で、かつ `Player` コンポーネントの `isGrounded` フラグが `true` の場合のみジャンプが可能です。
-   **処理**:
    -   `Velocity` コンポーネントの `dy` に、上向きの力 `JUMP_FORCE` を設定します。
    -   `isGrounded` フラグを `false` に設定し、連続でジャンプできないようにします。
-   **注意**: `isGrounded` フラグを `true` に戻すのは、このシステムではなく `collisionSystem` の責務です。

## 4. 依存関係

-   **`World`**: プレイヤーエンティティと関連コンポーネントをクエリし、更新するために使用します。
-   **`Input`**: マウスの移動量を取得するために使用します。
-   **`ThreeJsContext`**: Three.jsの `PointerLockControls` インスタンスにアクセスするために使用します。