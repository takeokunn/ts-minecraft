# Player System

プレイヤーシステムは、ユーザーとゲームワールドとのあらゆるインタラクションの中核を担います。ユーザーの入力をエンティティの移動、カメラの回転、ジャンプなどのアクションに変換する責務を持ちます。

## 関連コンポーネント

プレイヤーエンティティは、その状態と能力を定義するいくつかのコンポーネントの集合体です。

-   **`Player`**: エンティティをプレイヤーとして識別するためのタグコンポーネント。プレイヤーが地面に接しているかどうかの状態 `isGrounded` を保持します。
-   **`Position`**: 3D空間におけるエンティティの現在位置。
-   **`Velocity`**: エンティティの現在の速度と方向を `dx, dy, dz` 軸で表します。移動ロジックが主に操作する対象です。
-   **`InputState`**: `forward`, `jump`, `sprint` など、プレイヤーの現在のキーボードとマウスの入力状態のスナップショット。
-   **`CameraState`**: カメラの `pitch` (上下の傾き) と `yaw` (左右の回転) を格納し、プレイヤーが見ている方向を決定します。
-   **`Collider`**: 衝突検知に使用される、エンティティの物理的なバウンディングボックスを定義します。
-   **`Gravity`**: エンティティが重力の影響を受けることを示すコンポーネント。

## システムの構成

プレイヤーの機能は、`src/systems/player.ts` 内で定義された2つの主要な `Effect` プログラムによって管理されます。これらは `playerControlSystem` として単一のシステムに統合され、毎フレーム実行されます。

### 1. `updateInputState`

-   **責務**: `InputState` コンポーネントを常に最新の状態に保つこと。
-   **処理**: `Input` サービスをポーリングしてキーボードとマウスボタンの現在の状態を取得し、プレイヤーエンティティの `InputState` コンポーネントを更新します。この処理は、他のロジックが最新の入力状態を参照できるよう、ゲームループの早い段階で実行されることが期待されます。

### 2. `handlePlayerActions`

-   **責務**: `InputState` やその他のコンポーネントを読み取り、プレイヤーの意図するアクションを計算し、それを `Velocity` や `CameraState` などのコンポーネントの変更に変換すること。
-   **処理**:
    1.  **クエリ**: `world.querySingle` を実行し、プレイヤーに関連するすべてのコンポーネント (`Player`, `InputState`, `Velocity`, `CameraState`, `Position`) を持つエンティティを取得します。
    2.  **カメラ制御**: マウスの移動量 (`movementX`, `movementY`) を `Input` サービスから取得し、`CameraState` の `yaw` と `pitch` を更新します。`pitch` は、プレイヤーが真上や真下を通り越して回転しないように、-90度から+90度の間にクランプ（制限）されます。
    3.  **移動計算**:
        -   `InputState` (`forward`, `left` など) と現在のカメラの `yaw` を読み取ります。
        -   プレイヤーの移動の意図に基づいて、水平方向の速度ベクトルを計算します。
        -   `sprint` が有効な場合、`PLAYER_SPEED` (5.0) に `SPRINT_MULTIPLIER` (1.5) が乗算され、移動速度が上昇します。
        -   移動入力がない場合は、現在の水平速度に `DECELERATION` (0.85) を乗算し、スムーズに停止させます。
    4.  **ジャンプ**: `jump` 入力が有効かつ `Player` コンポーネントの `isGrounded` フラグが `true` の場合、`Velocity` の `dy` に `JUMP_VELOCITY` (8.0) を設定して垂直方向の推進力を与え、`isGrounded` を `false` に設定して連続ジャンプを防ぎます。
    5.  **コンポーネント更新**: 最後に、計算された新しい速度とカメラの状態を `World` 内の `Velocity` および `CameraState` コンポーネントに書き込みます。

## データフロー

プレイヤーシステムは、毎フレーム明確な一方向のデータフローに従います。

`Input Service` -> **`updateInputState`** -> `InputState Component` -> **`handlePlayerActions`** -> `Velocity` & `CameraState` Components

このサイクルにより、プレイヤーのアクションが予測可能に処理されます。まず入力が収集され、次に行動の意図が決定され、最後に物理的な状態 (`Velocity`) が変更されます。後続の `physics` や `collision` といったシステムは、この更新された `Velocity` を使って `Position` を変更し、実際にプレイヤーをワールド内で移動させます。
